<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=0.1, maximum-scale=6.0, user-scalable=yes">
    <title>砂石运输计划</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="top-right-tabs" aria-label="快捷切换">
        <button id="topTabPlanner" class="top-tab active" title="排程">排程</button>
        <button id="topTabConfig" class="top-tab" title="配置">配置</button>
        <button id="topTabCommission" class="top-tab" title="车税管理">车税管理</button>
        <button id="topTabDashboard" class="top-tab" title="仪表盘">仪表盘</button>
    </div>
    <!-- Toast notifications -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <div class="container">
        <div class="toolbar">
            <!-- <h2>每日物流排程</h2> -->
            <div class="date-navigator">
                <button class="btn btn-nav" onclick="navigateDate(-1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15,18 9,12 15,6"></polyline>
                    </svg>
                </button>
                <input type="date" id="datePicker" class="date-input" aria-label="选择日期">
                <!-- <span class="current-date" id="currentDate"></span> -->
                <button class="btn btn-nav" onclick="navigateDate(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9,18 15,12 9,6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="toolbar-actions" style="display:flex;gap:8px;align-items:center">
                <div class="zoom-controls" aria-label="缩放">
                    <button id="fitAll" class="zoom-btn primary" title="适配整页">Fit All</button>
                    <button id="zoomOut" class="zoom-btn" title="缩小">—</button>
                    <span id="zoomValue" style="min-width:48px;text-align:center">100%</span>
                    <button id="zoomIn" class="zoom-btn" title="放大">＋</button>
                </div>
            </div>
            <!-- <div class="toolbar-actions">
                <div class="search-box">
                    <input id="searchInput" class="search-input" type="text" placeholder="搜索啰里/工厂/产品/地方">
                </div>
                <button class="btn btn-secondary" id="btnFit" title="Fit more trips on screen">Fit to Screen</button>
                <button class="btn btn-secondary" id="btnConfig">配置</button>
                <button class="btn btn-secondary" id="btnCommissionManager" title="管理工厂/产品/地方与车税组合">车税规则</button>
        </div> -->
        </div>

        <div class="table-container">
            <div class="table-wrapper">
                <div class="scale-frame">
                    <table id="logisticsTable">
                        <thead>
                            <tr class="trip-group-header">
                                <th class="frozen-column"></th>
                                <th class="trip-header" colspan="6">行程 1</th>
                                <th class="trip-header" colspan="6">行程 2</th>
                                <th class="trip-header" colspan="6">行程 3</th>
                                <th class="trip-header" colspan="6">行程 4</th>
                                <th class="trip-header" colspan="6">行程 5</th>
                                <th class="trip-header additional-header" colspan="2">额外费用</th>
                                <th class="trip-header stats-header" rowspan="2">车税统计</th>
                            </tr>
                            <tr class="columns-header">
                                <th class="frozen-column sortable" data-column="plate"><span
                                        class="column-label">啰里</span></th>
                                <th class="sortable trip1-bg" data-column="pickup1"><span class="column-label">工厂</span>
                                </th>
                                <th class="sortable trip1-bg" data-column="product1"><span
                                        class="column-label">产品</span></th>
                                <th class="sortable trip1-bg" data-column="destination1"><span
                                        class="column-label">地方</span></th>
                                <th class="completion-header trip1-bg"><span class="column-label">完成</span></th>
                                <th class="sortable trip1-bg" data-column="commission1"><span
                                        class="column-label">车税（RM）</span></th>
                                <th class="trip1-bg" data-column="remarks1"><span class="column-label">备注</span></th>
                                <th class="trip-separator sortable trip2-bg" data-column="pickup2"><span
                                        class="column-label">工厂</span></th>
                                <th class="sortable trip2-bg" data-column="product2"><span
                                        class="column-label">产品</span></th>
                                <th class="sortable trip2-bg" data-column="destination2"><span
                                        class="column-label">地方</span></th>
                                <th class="completion-header trip2-bg"><span class="column-label">完成</span></th>
                                <th class="sortable trip2-bg" data-column="commission2"><span
                                        class="column-label">车税（RM）</span></th>
                                <th class="trip2-bg" data-column="remarks2"><span class="column-label">备注</span></th>
                                <th class="trip-separator sortable trip3-bg" data-column="pickup3"><span
                                        class="column-label">工厂</span></th>
                                <th class="sortable trip3-bg" data-column="product3"><span
                                        class="column-label">产品</span></th>
                                <th class="sortable trip3-bg" data-column="destination3"><span
                                        class="column-label">地方</span></th>
                                <th class="completion-header trip3-bg"><span class="column-label">完成</span></th>
                                <th class="sortable trip3-bg" data-column="commission3"><span
                                        class="column-label">车税（RM）</span></th>
                                <th class="trip3-bg" data-column="remarks3"><span class="column-label">备注</span></th>
                                <th class="trip-separator sortable trip4-bg" data-column="pickup4"><span
                                        class="column-label">工厂</span></th>
                                <th class="sortable trip4-bg" data-column="product4"><span
                                        class="column-label">产品</span></th>
                                <th class="sortable trip4-bg" data-column="destination4"><span
                                        class="column-label">地方</span></th>
                                <th class="completion-header trip4-bg"><span class="column-label">完成</span></th>
                                <th class="sortable trip4-bg" data-column="commission4"><span
                                        class="column-label">车税（RM）</span></th>
                                <th class="trip4-bg" data-column="remarks4"><span class="column-label">备注</span></th>
                                <th class="trip-separator sortable trip5-bg" data-column="pickup5"><span
                                        class="column-label">工厂</span></th>
                                <th class="sortable trip5-bg" data-column="product5"><span
                                        class="column-label">产品</span></th>
                                <th class="sortable trip5-bg" data-column="destination5"><span
                                        class="column-label">地方</span></th>
                                <th class="completion-header trip5-bg"><span class="column-label">完成</span></th>
                                <th class="sortable trip5-bg" data-column="commission5"><span
                                        class="column-label">车税（RM）</span></th>
                                <th class="trip5-bg" data-column="remarks5"><span class="column-label">备注</span></th>
                                <th class="additional-column sortable" data-column="tol_amount"><span
                                        class="column-label">过路费（RM）</span></th>
                                <th class="additional-column sortable" data-column="petrol_amount"><span
                                        class="column-label">油费（RM）</span></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Active Trips Board (new): shows all trips simultaneously in large, readable cards -->
        <div id="tripOverviewContainer" class="trip-board" style="display:none"></div>
    </div>

    <!-- Commission Modal -->
    <div class="modal-overlay" id="commissionModal" style="display:none">
        <div class="modal">
            <div class="modal-header">
                <span>车税管理</span>
                <button class="close-btn" id="closeCommission" title="关闭">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; height: calc(100vh - 120px);">
                <iframe id="ifrCommission" src="commission-manager.html?v=embedded" title="车税管理"
                    style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <!-- 车税管理模态框 -->
    <div class="modal-overlay" id="dashboardModal" style="display:none">
        <div class="modal dashboard-modal">
            <div class="modal-header">
                <div class="dashboard-title">
                    <span>仪表盘</span>
                    <div class="date-range" id="dashboardDateRange">01/01/2025 - 31/01/2025</div>
                </div>
                <button class="close-btn" id="closeDashboard" title="关闭">&times;</button>
            </div>
            <div class="modal-body">
                <div class="dashboard-header">
                    <div class="period-selector">
                        <button id="periodPrev" class="btn btn-nav" title="上一期">‹</button>
                        <label for="periodSelect">统计周期：</label>
                        <select id="periodSelect" class="period-select">
                            <option value="week">周</option>
                            <option value="month" selected>月</option>
                            <option value="year">年</option>
                        </select>
                        <input type="date" id="periodDate" class="period-date">
                        <button id="periodNext" class="btn btn-nav" title="下一期">›</button>
                    </div>
                </div>

                <div class="dashboard-content">
                    <div class="stats-summary">
                        <div class="stat-card">
                            <h3>总车辆数</h3>
                            <div class="stat-value" id="totalVehicles">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>总行程数</h3>
                            <div class="stat-value" id="totalTrips">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>总车税</h3>
                            <div class="stat-value" id="totalCommission">RM -</div>
                        </div>
                        <div class="stat-card">
                            <h3>总费用</h3>
                            <div class="stat-value" id="totalExpenses">RM -</div>
                        </div>
                    </div>


                    <div class="vehicle-details-table" id="accordionVehicles">
                        <h3 class="accordion-header" role="button" aria-expanded="true">
                            <span>车辆详细统计</span>
                            <span class="accordion-indicator" aria-hidden="true">▾</span>
                        </h3>
                        <div class="table-wrapper">
                            <table id="vehicleStatsTable" class="dashboard-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-key="plate">啰里 <span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="trips">行程数 <span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="commission">车税 (RM) <span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="tollFees">过路费 (RM) <span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="fuelCosts">油费 (RM) <span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="totalExpenses">总费用 (RM) <span class="sort-indicator"></span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Destination Last Delivery Table -->
                    <div class="destination-details-table" id="accordionDestinations">
                        <h3 class="accordion-header" role="button" aria-expanded="true">
                            <span>地方订单统计</span>
                            <span class="accordion-indicator" aria-hidden="true">▾</span>
                        </h3>
                        <div class="table-wrapper">
                            <table id="destinationStatsTable" class="dashboard-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-key="destination">地方<span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="lastDate">最后一次运送日期<span class="sort-indicator"></span></th>
                                        <th class="sortable" data-key="daysSince">距离今天（天）<span class="sort-indicator"></span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration Modal -->
    <div class="modal-overlay" id="configModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <span>系统配置</span>
                <span id="unsavedBadge" class="unsaved-badge" title="有未保存的更改" style="display:none">未保存更改</span>
                <button class="close-btn" id="btnCloseConfig">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-tabs">
                    <button class="tab-btn active" data-tab="tab-lorry">啰里</button>
                    <button class="tab-btn" data-tab="tab-pickup">工厂</button>
                    <button class="tab-btn" data-tab="tab-product">产品</button>
                    <button class="tab-btn" data-tab="tab-destination">地方</button>
                    <!-- 已移除：车税、默认 -->
                    <button class="tab-btn" data-tab="tab-colors">颜色</button>
                    <button class="tab-btn" data-tab="tab-reasons">原因</button>
                </div>

                <div class="tab-panel active" id="tab-lorry">
                    <div class="config-input-row">
                        <input type="text" id="inputLorryPlate" placeholder="添加啰里">
                        <button class="btn btn-primary" id="btnAddLorry">添加</button>
                    </div>
                    <div class="config-input-row">
                        <input type="text" id="searchLorry" placeholder="搜索啰里">
                    </div>
                    <div class="config-split">
                        <div class="config-block">
                            <div class="config-block-title">活动啰里

                            </div>
                            <table class="config-table" id="tableLorry">
                                <thead>
                                    <tr>
                                        <th>啰里</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <div class="tab-panel" id="tab-pickup">
                    <div class="config-input-row">
                        <input type="text" id="inputPickUp" placeholder="添加工厂">
                        <button class="btn btn-primary" id="btnAddPickUp">添加</button>
                    </div>
                    <div class="config-input-row"><input type="text" id="searchPickUp" placeholder="搜索工厂"></div>
                    <div class="alpha-index" id="alpha-pickup"></div>
                    <table class="config-table" id="tablePickUp">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="tab-panel" id="tab-product">
                    <div class="config-input-row">
                        <input type="text" id="inputProduct" placeholder="添加产品">
                        <button class="btn btn-primary" id="btnAddProduct">添加</button>
                    </div>
                    <div class="config-input-row"><input type="text" id="searchProduct" placeholder="搜索产品"></div>
                    <div class="alpha-index" id="alpha-product"></div>
                    <table class="config-table" id="tableProduct">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="tab-panel" id="tab-destination">
                    <div class="config-input-row">
                        <input type="text" id="inputDestination" placeholder="添加地方">
                        <button class="btn btn-primary" id="btnAddDestination">添加</button>
                    </div>
                    <div class="config-input-row"><input type="text" id="searchDestination" placeholder="搜索地方">
                    </div>
                    <div class="alpha-index" id="alpha-destination"></div>
                    <table class="config-table" id="tableDestination">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>


                <!-- 已移除：车税与默认配置面板 -->

                <div class="tab-panel" id="tab-colors">
                    <div class="config-card" style="border:none;padding:0;background:transparent">
                        <div class="config-grid">
                            <label>行程1颜色 <input type="color" id="colorTrip1"></label>
                            <label>行程2颜色 <input type="color" id="colorTrip2"></label>
                            <label>行程3颜色 <input type="color" id="colorTrip3"></label>
                            <label>行程4颜色 <input type="color" id="colorTrip4"></label>
                            <label>行程5颜色 <input type="color" id="colorTrip5"></label>
                        </div>
                        <small style="color:#6c757d">设置每个行程列的背景色。</small>
                    </div>
                </div>

                <div class="tab-panel" id="tab-reasons">
                    <div class="config-split">
                        <div class="config-block">
                            <div class="config-block-title">原因组合</div>
                            <div class="config-input-row">
                                <input type="text" id="inputReasonGroup" placeholder="添加原因组合 (例如: 客户, 司机, 啰里, JPJ)">
                                <button class="btn btn-primary" id="btnAddReasonGroup">添加</button>
                            </div>
                            <div class="config-input-row">
                                <input type="text" id="searchReasonGroup" placeholder="搜索原因组合">
                            </div>
                            <table class="config-table" id="tableReasonGroup">
                                <thead>
                                    <tr>
                                        <th>原因组合</th>
                                        <th>原因数量</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="config-block">
                            <div class="config-block-title">原因详情</div>
                            <div id="reasonGroupSelector" style="margin-bottom: 10px;">
                                <label>选择原因组合: </label>
                                <select id="selectReasonGroup"
                                    style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">请先选择原因组合</option>
                                </select>
                            </div>
                            <div class="config-input-row">
                                <input type="text" id="inputReason" placeholder="添加原因 (例如: MC, Buat IC, Balik Kampung)"
                                    disabled>
                                <button class="btn btn-primary" id="btnAddReason" disabled>添加</button>
                            </div>
                            <div class="config-input-row">
                                <input type="text" id="searchReason" placeholder="搜索原因" disabled>
                            </div>
                            <table class="config-table" id="tableReason">
                                <thead>
                                    <tr>
                                        <th>原因</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="btnSaveConfig">保存配置</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SheetJS for reading Excel commission rules -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Supabase client via Vercel env: fetched from /api/config
        let sb = null;
        async function initSupabase() {
            try {
                // Try serverless config first (Vercel/prod)
                const res = await fetch('/api/config', { cache: 'no-store' });
                const env = await res.json();
                const url = env.SUPABASE_URL || env.url;
                const key = env.SUPABASE_ANON_KEY || env.key;
                if (url && key) {
                    sb = window.supabase.createClient(url, key);
                    window.__SB = sb;
                    return;
                }
            } catch (_) {
                /* fall through to local fallback */
            }
            // Local fallback: allow testing without serverless /api/config
            try {
                const url = window.__SUPABASE_URL || localStorage.getItem('SUPABASE_URL');
                const key = window.__SUPABASE_ANON_KEY || localStorage.getItem('SUPABASE_ANON_KEY');
                if (url && key) {
                    sb = window.supabase.createClient(url, key);
                    window.__SB = sb;
                    console.warn('Supabase initialized from local fallback variables');
                    return;
                }
            } catch (_) { }
            // No Supabase available; continue in local-only mode
            sb = null;
            console.warn('Supabase not configured. Running in local-only mode.');
        }
        // Runtime dataset. Start empty to avoid resurrecting seeded demo rows on refresh.
        let sampleData = [];
        // Detect if Supabase 'schedules' table has per-trip reason columns (t1_reason ... t5_reason)
        let HAS_REASON_COLUMNS = false;

        // Configuration handling
        const defaultConfig = {
            lorryPlates: ["8722", "8915", "4250", "907", "5708"],
            hiddenLorryPlates: [],
            archivedLorryPlates: [],
            // When true, prefer local lorryPlates over DB values on load
            overrideLorryPlates: false,
            pickUps: [
                "", "Highway Quarry", "Majumas Bestari", "RCJ", "LORI ROSAK", "CST",
                "IJM", "Takali Sunway", "Pepsi", "Hanson Cheras", "Guna"
            ],
            products: [
                "", "3/4 Agg", "C/Sand", "C/run", "Icp kapar", "Kajang Setia Mix",
                "Langat Tong Ooi", "Kuchai Ytl", "Nilai MDC", "Belakong Ytl", "Setia mix semen",
                "Subang Gy two", "Puchong ulus wt"
            ],
            destinations: [
                "", "Nilai MDC", "Subang Gy two", "B. Jalil", "Tasik Selatan", "Icp kebun",
                "kapar k345 lucat", "K345 Lucas", "sps chong", "Kuchai Ytl", "Kajang Setia Mix",
                "Langat Tong Ooi", "Belakong Ytl", "Setia mix semen", "Suntiga Sg Rasa",
                "Kapar U wajar", "kapar k345 lucat", "Puchong ulus wt", "K Garden Kapar"
            ],
            commissions: ["5.50", "10.00", "10.50", "11.50", "13.50", "14.00"],
            defaultCompletion: false,
            tripColors: {
                trip1: '#e3f2fd',
                trip2: '#f3e5f5',
                trip3: '#e8f5e8',
                trip4: '#fff3e0',
                trip5: '#fce4ec'
            }
        };

        // Page-fit / custom zoom removed — rely on browser default zoom
        const IS_TOUCH = window.matchMedia('(pointer: coarse)').matches || ('ontouchstart' in window);
        function applyPageFit() { }
        function disablePageFit() { }

        function loadConfig() {
            try {
                const raw = localStorage.getItem('nanyang_config');
                if (!raw) return { ...defaultConfig };
                const parsed = JSON.parse(raw);
                return { ...defaultConfig, ...parsed };
            } catch (e) {
                console.warn('Failed to load config, using defaults', e);
                return { ...defaultConfig };
            }
        }

        function applyTripColors(cfg) {
            const colors = (cfg && cfg.tripColors) ? cfg.tripColors : defaultConfig.tripColors;
            const root = document.documentElement;
            root.style.setProperty('--trip1-bg', colors.trip1);
            root.style.setProperty('--trip2-bg', colors.trip2);
            root.style.setProperty('--trip3-bg', colors.trip3);
            root.style.setProperty('--trip4-bg', colors.trip4);
            root.style.setProperty('--trip5-bg', colors.trip5);
        }

        function saveConfig(cfg) {
            localStorage.setItem('nanyang_config', JSON.stringify(cfg));
        }

        // Commission rules sources and final map
        // Structure: Map key "pickUp|product|destination" (lowercased, trimmed) -> commission string
        // COMMISSION_RULES value types:
        // - number/string: flat rate (e.g., from Excel override)
        // - array of { rate:number|string, start?:string, end?:string }: date-based rates
        let COMMISSION_RULES = new Map();
        let EXCEL_COMMISSION_RULES = new Map();
        let SUPABASE_COMMISSION_RULES = new Map();

        function normalizeKey(pu, pr, de) {
            const norm = (s) => (s || '').toString().trim().toLowerCase();
            return `${norm(pu)}|${norm(pr)}|${norm(de)}`;
        }

        function getProductsForPickUp(pickUp) {
            // Get unique products available for a specific pick up location
            if (!COMMISSION_RULES || COMMISSION_RULES.size === 0) return [];

            const puNorm = (pickUp || '').toString().trim().toLowerCase();
            if (!puNorm) return [];

            const products = new Set();

            // Iterate through all commission rules to find matching pick up locations
            for (const [key, value] of COMMISSION_RULES.entries()) {
                const [keyPu, keyPr, keyDe] = key.split('|');
                if (keyPu === puNorm && keyPr && keyDe) {
                    // Find the original case-sensitive product name from productOptions
                    const originalProduct = productOptions.find(p =>
                        p.toString().trim().toLowerCase() === keyPr
                    );
                    if (originalProduct) {
                        products.add(originalProduct);
                    }
                }
            }

            return Array.from(products).sort((a, b) => a.localeCompare(b));
        }

        function getDestinationsForPickUp(pickUp) {
            // Get unique destinations available for a specific pick up location
            if (!COMMISSION_RULES || COMMISSION_RULES.size === 0) return [];

            const puNorm = (pickUp || '').toString().trim().toLowerCase();
            if (!puNorm) return [];

            const destinations = new Set();

            // Iterate through all commission rules to find matching pick up locations
            for (const [key, value] of COMMISSION_RULES.entries()) {
                const [keyPu, keyPr, keyDe] = key.split('|');
                if (keyPu === puNorm && keyPr && keyDe) {
                    // Find the original case-sensitive destination name from destinationOptions
                    const originalDestination = destinationOptions.find(d =>
                        d.toString().trim().toLowerCase() === keyDe
                    );
                    if (originalDestination) {
                        destinations.add(originalDestination);
                    }
                }
            }

            return Array.from(destinations).sort((a, b) => a.localeCompare(b));
        }

        function getCommissionFromRules(pu, pr, de, dateContext = currentDate) {
            // Strict matching only: if any field is blank, do NOT apply commission
            if (!COMMISSION_RULES || COMMISSION_RULES.size === 0) return null;
            const puN = (pu || '').toString().trim();
            const prN = (pr || '').toString().trim();
            const deN = (de || '').toString().trim();
            if (!puN || !prN || !deN) return null;
            const key = normalizeKey(pu, pr, de);
            let val = COMMISSION_RULES.get(key);
            if (val == null) return null; // no match strictly
            // If val is an array, pick by date range
            if (Array.isArray(val)) {
                const d = new Date(dateContext);
                const iso = (dt) => {
                    if (!dt) return null;
                    const t = new Date(dt);
                    if (Number.isNaN(t.getTime())) return null;
                    return `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')}`;
                };
                const curISO = iso(d);
                // Prefer most recent start date that includes current date
                const candidates = val.filter(r => {
                    const sISO = iso(r.start);
                    const eISO = iso(r.end);
                    if (!sISO && !eISO) return true; // open-ended
                    if (sISO && curISO < sISO) return false;
                    if (eISO && curISO > eISO) return false;
                    return true;
                }).sort((a, b) => {
                    const aS = iso(a.start) || '0000-00-00';
                    const bS = iso(b.start) || '0000-00-00';
                    // later start first
                    return bS.localeCompare(aS);
                });
                const chosen = candidates[0];
                if (!chosen) return null;
                val = chosen.rate;
            }
            // number or string: normalize and return to 2 decimals
            if (typeof val === 'number' && !isNaN(val)) {
                return String(Number(val).toFixed(2));
            }
            const m = String(val).match(/[0-9]+(?:\.[0-9]+)?/);
            if (!m) return null;
            return String(Number(m[0]).toFixed(2));
        }

        async function loadCommissionRulesFromExcel(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Failed to fetch Excel: ${res.status}`);
                const ab = await res.arrayBuffer();
                const wb = XLSX.read(ab, { type: 'array' });
                const sheetName = wb.SheetNames[0];
                const ws = wb.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
                if (!rows || rows.length === 0) return;
                // Detect header columns flexibly (supports English, Malay, Chinese labels)
                let startIdx = 0;
                let idxPU = 0, idxPR = 1, idxDE = 2, idxCM = 3;
                const normH = (s) => (s || '').toString().trim().toLowerCase();
                const header = rows[0] || [];
                const normalizedHeader = header.map(normH);
                const hasHeader = normalizedHeader.length > 0 && (
                    normalizedHeader.some(h => h.includes('pick')) ||
                    normalizedHeader.some(h => h.includes('source')) ||
                    normalizedHeader.some(h => h.includes('from')) ||
                    normalizedHeader.some(h => h.includes('地点') || h.includes('lokasi'))
                );
                if (hasHeader) {
                    startIdx = 1;
                    const findIdx = (cands) => {
                        for (let i = 0; i < normalizedHeader.length; i++) {
                            const h = normalizedHeader[i];
                            if (cands.some(c => h.includes(c))) return i;
                        }
                        return -1;
                    };
                    idxPU = findIdx(['pick', 'pickup', 'from', 'source', '地点', 'lokasi']);
                    idxPR = findIdx(['product', 'prod', '货', 'barang']);
                    idxDE = findIdx(['destination', 'dest', 'to', '地方', 'tempat']);
                    idxCM = findIdx(['commission', 'rm', 'fee', '车税', 'tax', 'harga']);
                    if (idxPU < 0) idxPU = 0;
                    if (idxPR < 0) idxPR = 1;
                    if (idxDE < 0) idxDE = 2;
                    if (idxCM < 0) idxCM = 3;
                } else {
                    startIdx = 0;
                }
                EXCEL_COMMISSION_RULES = new Map();
                const puSet = new Set();
                const prSet = new Set();
                const deSet = new Set();
                const rulesRows = [];
                for (let i = startIdx; i < rows.length; i++) {
                    const r = rows[i] || [];
                    const pu = (r[idxPU] ?? '').toString();
                    const pr = (r[idxPR] ?? '').toString();
                    const de = (r[idxDE] ?? '').toString();
                    let cmRaw = (r[idxCM] ?? '').toString();
                    // Strict: only accept commission from the detected column
                    if (!cmRaw) continue;
                    // Strict: require all three fields and commission present
                    if (!pu || !pr || !de) continue;
                    const key = normalizeKey(pu, pr, de);
                    // Extract numeric part of commission
                    let cmNum = null;
                    const m = String(cmRaw).match(/[0-9]+(?:\.[0-9]+)?/);
                    if (m) cmNum = Number(parseFloat(m[0]).toFixed(2));
                    // Only record rules with a non-empty commission
                    if (cmNum != null) {
                        EXCEL_COMMISSION_RULES.set(key, cmNum);
                    } else {
                        // Skip empty commission entries entirely
                        continue;
                    }
                    if (pu) puSet.add(pu);
                    if (pr) prSet.add(pr);
                    if (de) deSet.add(de);
                    rulesRows.push({ pick_up: pu, product: pr, destination: de, commission: cmNum, active: true });
                }
                // Update local CONFIG options and UI option arrays from Excel values (remove blank entries)
                const puList = Array.from(puSet).filter(v => (v || '').trim().length > 0);
                const prList = Array.from(prSet).filter(v => (v || '').trim().length > 0);
                const deList = Array.from(deSet).filter(v => (v || '').trim().length > 0);
                CONFIG.pickUps = puList;
                CONFIG.products = prList;
                CONFIG.destinations = deList;
                saveConfig(CONFIG);
                pickUpOptions = CONFIG.pickUps;
                productOptions = CONFIG.products;
                destinationOptions = CONFIG.destinations;

                // Persist options to Supabase config_options
                const optRows = [];
                Array.from(puSet).forEach(name => optRows.push({ category: 'pickup', name, active: true }));
                Array.from(prSet).forEach(name => optRows.push({ category: 'product', name, active: true }));
                Array.from(deSet).forEach(name => optRows.push({ category: 'destination', name, active: true }));
                if (optRows.length) {
                    await sb.from('config_options').upsert(optRows, { onConflict: 'category,name' });
                }
                // Persist combination->commission rules to Supabase
                if (rulesRows.length) {
                    // Try to insert each rule individually to handle exclusion constraint violations
                    for (const rule of rulesRows) {
                        try {
                            const { error } = await sb.from('commission_rules').insert([rule]);
                            if (error) {
                                // If it's an exclusion constraint violation, we can skip or handle it
                                if (error.code === '23P01') {
                                    console.warn('Skipping overlapping rule:', rule);
                                } else {
                                    console.warn('Failed to insert rule:', rule, error);
                                }
                            }
                        } catch (e) {
                            console.warn('Failed to insert rule:', rule, e);
                        }
                    }
                }
            } catch (e) {
                console.warn('Failed to load commission rules from Excel', e);
            }
        }

        function applyCommissionToSampleData() {
            if (!Array.isArray(sampleData)) return;
            sampleData.forEach(row => {
                [row.trip1, row.trip2, row.trip3, row.trip4, row.trip5].forEach(trip => {
                    if (!trip) return;
                    // Rule: If any of the three fields is empty, clear commission
                    const puBlank = !(trip.pickUp || '').toString().trim();
                    const prBlank = !(trip.product || '').toString().trim();
                    const deBlank = !(trip.destination || '').toString().trim();
                    if (puBlank || prBlank || deBlank) {
                        trip.commission = '';
                        return;
                    }
                    const cm = getCommissionFromRules(trip.pickUp, trip.product, trip.destination, currentDate);
                    // Only auto-fill when commission is non-empty; otherwise clear
                    if (cm != null && cm !== '') {
                        trip.commission = cm;
                    } else {
                        trip.commission = '';
                    }
                });
            });
        }

        async function loadCommissionRulesFromSupabase() {
            try {
                const { data, error } = await sb.from('commission_rules')
                    .select('pick_up,product,destination,commission,active,valid_from,valid_to');
                if (error) throw error;
                SUPABASE_COMMISSION_RULES = new Map();
                (data || []).forEach(row => {
                    const pu = (row.pick_up || '').toString().trim();
                    const pr = (row.product || '').toString().trim();
                    const de = (row.destination || '').toString().trim();
                    const cm = row.commission;
                    const active = row.active !== false; // default to true
                    const start = row.valid_from || null;
                    const end = row.valid_to || null;
                    if (!active) return;
                    if (!pu || !pr || !de) return; // ignore blank keys entirely
                    if (cm == null || cm === '') return;
                    const key = normalizeKey(pu, pr, de);
                    const arr = SUPABASE_COMMISSION_RULES.get(key) || [];
                    arr.push({ rate: cm, start, end });
                    SUPABASE_COMMISSION_RULES.set(key, arr);
                });
            } catch (e) {
                console.warn('Failed to load commission rules from Supabase', e);
                SUPABASE_COMMISSION_RULES = new Map();
            }
        }

        function mergeCommissionRulesPreferExcel() {
            // Start with Supabase rules (date-based)
            const merged = new Map(SUPABASE_COMMISSION_RULES);
            // Override with Excel rules: treat as open-ended flat rate
            for (const [k, v] of EXCEL_COMMISSION_RULES.entries()) {
                merged.set(k, [{ rate: v, start: null, end: null }]);
            }
            COMMISSION_RULES = merged;
        }

        async function supabaseLoadOptions() {
            if (!sb) {
                // No Supabase: rely on local config/defaults already loaded into CONFIG
                try {
                    CONFIG = loadConfig();
                    applyTripColors(CONFIG);
                    pickUpOptions = (CONFIG.pickUps || []).map(v => String(v).trim()).filter(Boolean);
                    productOptions = (CONFIG.products || []).map(v => String(v).trim()).filter(Boolean);
                    destinationOptions = (CONFIG.destinations || []).map(v => String(v).trim()).filter(Boolean);
                } catch (e) { console.warn('Local options fallback failed', e); }
                return;
            }
            try {
                const [opts, settings] = await Promise.all([
                    sb.from('config_options').select('category,name,active').eq('active', true),
                    sb.from('app_settings').select('key,value').in('key', ['defaultCompletion', 'tripColors'])
                ]);
                const local = loadConfig();
                const cfg = { ...defaultConfig };
                if (!opts.error && opts.data) {
                    const byCat = (cat) => opts.data.filter(r => r.category === cat).map(r => r.name);
                    // Use DB lorry plates unless local override is set
                    if (local && local.overrideLorryPlates === true) {
                        cfg.lorryPlates = (local.lorryPlates || []).map(v => String(v).trim()).filter(Boolean);
                        cfg.overrideLorryPlates = true;
                    } else {
                        cfg.lorryPlates = byCat('lorry_plate').map(v => String(v).trim()).filter(Boolean);
                        cfg.overrideLorryPlates = false;
                        // Fallback to local/default when DB is empty
                        if (!cfg.lorryPlates || cfg.lorryPlates.length === 0) {
                            cfg.lorryPlates = (local.lorryPlates || defaultConfig.lorryPlates).map(v => String(v).trim()).filter(Boolean);
                        }
                    }
                    // Merge Supabase options with local defaults when DB is empty
                    const normList = (arr = []) => arr.map(v => String(v).trim()).filter(Boolean);
                    const ensureList = (list, fallback) => (Array.isArray(list) && list.length ? list : fallback);
                    const puDB = byCat('pickup').map(v => String(v).trim()).filter(Boolean);
                    const prDB = byCat('product').map(v => String(v).trim()).filter(Boolean);
                    const deDB = byCat('destination').map(v => String(v).trim()).filter(Boolean);
                    const coDB = byCat('commission').map(v => String(v).trim()).filter(Boolean);
                    cfg.pickUps = ensureList(puDB, normList(local.pickUps || defaultConfig.pickUps));
                    cfg.products = ensureList(prDB, normList(local.products || defaultConfig.products));
                    cfg.destinations = ensureList(deDB, normList(local.destinations || defaultConfig.destinations));
                    cfg.commissions = ensureList(coDB, normList(local.commissions || defaultConfig.commissions));
                }
                // Load app settings
                if (!settings.error && Array.isArray(settings.data)) {
                    const map = new Map(settings.data.map(r => [r.key, r.value]));
                    const dc = map.get('defaultCompletion');
                    if (dc && typeof dc.value === 'boolean') {
                        cfg.defaultCompletion = !!dc.value;
                    }
                    const tc = map.get('tripColors');
                    if (tc && typeof tc === 'object') {
                        cfg.tripColors = {
                            trip1: tc.trip1 || cfg.tripColors.trip1,
                            trip2: tc.trip2 || cfg.tripColors.trip2,
                            trip3: tc.trip3 || cfg.tripColors.trip3,
                            trip4: tc.trip4 || cfg.tripColors.trip4,
                            trip5: tc.trip5 || cfg.tripColors.trip5
                        };
                    }
                }
                // Merge in local hidden state so it persists client-side
                const mergeSet = (a = [], b = []) => Array.from(new Set([...(a || []), ...(b || [])]));
                cfg.hiddenLorryPlates = mergeSet(cfg.hiddenLorryPlates, local.hiddenLorryPlates);
                cfg.archivedLorryPlates = [];
                CONFIG = cfg;
                pickUpOptions = (CONFIG.pickUps || []).map(v => String(v).trim()).filter(Boolean);
                productOptions = (CONFIG.products || []).map(v => String(v).trim()).filter(Boolean);
                destinationOptions = (CONFIG.destinations || []).map(v => String(v).trim()).filter(Boolean);
                applyTripColors(CONFIG);
            } catch (e) {
                console.warn('Failed to load options from Supabase, using local config', e);
                CONFIG = loadConfig();
                pickUpOptions = (CONFIG.pickUps || []).map(v => String(v).trim()).filter(Boolean);
                productOptions = (CONFIG.products || []).map(v => String(v).trim()).filter(Boolean);
                destinationOptions = (CONFIG.destinations || []).map(v => String(v).trim()).filter(Boolean);
                applyTripColors(CONFIG);
            }
        }

        async function supabaseSaveOptions() {
            try {
                // Normalize and build new active rows
                const uniq = (arr = []) => Array.from(new Set(arr.map(v => (v || '').trim()).filter(Boolean)));
                const newByCat = {
                    lorry_plate: uniq(CONFIG.lorryPlates || []),
                    pickup: uniq((CONFIG.pickUps || []).filter(Boolean)),
                    product: uniq((CONFIG.products || []).filter(Boolean)),
                    destination: uniq((CONFIG.destinations || []).filter(Boolean)),
                    commission: uniq((CONFIG.commissions || []).filter(Boolean))
                };
                const rows = [];
                Object.entries(newByCat).forEach(([category, list]) => {
                    list.forEach(name => rows.push({ category, name, active: true }));
                });

                // Fetch existing active rows to compute deletions/inactivations
                const existing = await sb.from('config_options').select('category,name,active');
                if (!existing.error && existing.data) {
                    const toDeactivate = [];
                    const groupExisting = {};
                    existing.data.forEach(r => {
                        if (!groupExisting[r.category]) groupExisting[r.category] = new Set();
                        if (r.active) groupExisting[r.category].add(r.name);
                    });
                    Object.entries(groupExisting).forEach(([cat, set]) => {
                        const newSet = new Set(newByCat[cat] || []);
                        set.forEach(name => { if (!newSet.has(name)) toDeactivate.push({ category: cat, name }); });
                    });
                    if (toDeactivate.length) {
                        // Group by category and mark removed items inactive
                        const byCat = {};
                        toDeactivate.forEach(r => { (byCat[r.category] ||= []).push(r.name); });
                        for (const [cat, namesAll] of Object.entries(byCat)) {
                            const namesUnique = Array.from(new Set(namesAll));
                            for (const names of chunkArray(namesUnique, 50)) {
                                await sb.from('config_options')
                                    .update({ active: false })
                                    .eq('category', cat)
                                    .in('name', names);
                            }
                        }
                    }
                }

                if (rows.length) {
                    await sb.from('config_options').upsert(rows, { onConflict: 'category,name' });
                }
                await sb.from('app_settings').upsert(
                    { key: 'defaultCompletion', value: { value: CONFIG.defaultCompletion } },
                    { onConflict: 'key' }
                );
                // Persist trip colors
                await sb.from('app_settings').upsert(
                    {
                        key: 'tripColors', value: {
                            trip1: CONFIG.tripColors?.trip1 || defaultConfig.tripColors.trip1,
                            trip2: CONFIG.tripColors?.trip2 || defaultConfig.tripColors.trip2,
                            trip3: CONFIG.tripColors?.trip3 || defaultConfig.tripColors.trip3,
                            trip4: CONFIG.tripColors?.trip4 || defaultConfig.tripColors.trip4,
                            trip5: CONFIG.tripColors?.trip5 || defaultConfig.tripColors.trip5
                        }
                    },
                    { onConflict: 'key' }
                );
                return true;
            } catch (e) {
                console.error('Failed saving options to Supabase', e);
                return false;
            }
        }

        // Helper: upsert a single option to Supabase and update local CONFIG/option arrays
        async function upsertOptionAndSync(category, name) {
            const val = String(name || '').trim();
            if (!val) return;
            try {
                await sb.from('config_options').upsert({ category, name: val, active: true }, { onConflict: 'category,name' });
            } catch (e) { console.warn('Upsert option failed', category, val, e); }
            const addUnique = (arr, v) => {
                const low = String(v).toLowerCase();
                if (!arr.some(x => String(x).toLowerCase() === low)) arr.push(v);
            };
            if (category === 'pickup') { addUnique(CONFIG.pickUps, val); pickUpOptions = CONFIG.pickUps; }
            if (category === 'product') { addUnique(CONFIG.products, val); productOptions = CONFIG.products; }
            if (category === 'destination') { addUnique(CONFIG.destinations, val); destinationOptions = CONFIG.destinations; }

            // Notify embedded commission manager to update its datalists immediately
            try {
                const ifr = document.getElementById('ifrCommission');
                if (ifr && ifr.contentWindow) {
                    ifr.contentWindow.postMessage({ type: 'optionsUpdated', added: [{ category, name: val }] }, '*');
                }
            } catch (_) { /* non-critical */ }
        }

        // Reset lorry plates to a specific list, removing others
        async function resetLorryPlatesTo(targetPlates = []) {
            try {
                const desired = Array.from(new Set((targetPlates || []).map(p => String(p).trim()).filter(Boolean)));
                // 1) Fetch current lorry_plates
                let current = [];
                try {
                    const r = await sb.from('lorry_plates').select('plate_no');
                    if (!r.error && r.data) current = r.data.map(d => String(d.plate_no));
                } catch (_) { /* non-critical */ }

                // 2) Delete plates not in desired
                const toDelete = current.filter(p => !desired.includes(p));
                if (toDelete.length) {
                    try {
                        const del = await sb.from('lorry_plates').delete().in('plate_no', toDelete);
                        if (del && del.error) {
                            // Fallback if hard delete blocked: mark plates inactive and hidden in bulk
                            await sb.from('lorry_plates').update({ active: false, hidden: true }).in('plate_no', toDelete);
                        }
                    } catch (_) {
                        // Best-effort fallback even if delete throws
                        try { await sb.from('lorry_plates').update({ active: false, hidden: true }).in('plate_no', toDelete); } catch (_) { }
                    }
                    // Also remove ALL schedule rows for the current date to ensure nothing resurfaces
                    try {
                        const dstr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                        await sb.from('schedules').delete().eq('work_date', dstr);
                    } catch (_) { }
                }

                // 3) Upsert desired plates
                const toAdd = desired.filter(p => !current.includes(p)).map(p => ({ plate_no: p, active: true }));
                if (toAdd.length) {
                    try { await sb.from('lorry_plates').upsert(toAdd, { onConflict: 'plate_no' }); } catch (_) { }
                }

                // 4) Update local CONFIG and persist options
                CONFIG.lorryPlates = desired;
                CONFIG.hiddenLorryPlates = [];
                CONFIG.archivedLorryPlates = [];
                saveConfig(CONFIG);
                await supabaseSaveOptions();

                // 5) Update current view rows to match desired
                const desiredSet = new Set(desired);
                sampleData = sampleData.filter(r => desiredSet.has(String(r.lorryPlate)));
                desired.forEach(p => {
                    if (!sampleData.some(r => String(r.lorryPlate) === String(p))) {
                        sampleData.push({
                            lorryPlate: p,
                            trip1: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip2: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip3: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip4: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip5: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                        });
                    }
                });

                // 6) Save schedule so persistence matches UI
                await supabaseSaveSchedule(currentDate, sampleData);
                sortSampleRows();
                populateTable();
            } catch (e) {
                console.warn('Reset lorry plates failed', e);
            }
        }

        // Hard clear all active lorry plates and today’s schedules, then refresh UI
        async function clearAllActivePlates() {
            try {
                // Fetch all current plates
                let all = [];
                try {
                    const r = await sb.from('lorry_plates').select('plate_no');
                    if (!r.error && r.data) all = r.data.map(d => String(d.plate_no));
                } catch (_) { }
                if (all.length) {
                    try {
                        const del = await sb.from('lorry_plates').delete().in('plate_no', all);
                        if (del && del.error) {
                            await sb.from('lorry_plates').update({ active: false, hidden: true }).in('plate_no', all);
                        }
                    } catch (_) {
                        try { await sb.from('lorry_plates').update({ active: false, hidden: true }).in('plate_no', all); } catch (_) { }
                    }
                }
                // Clear today’s schedules entirely
                try {
                    const dstr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    await sb.from('schedules').delete().eq('work_date', dstr);
                } catch (_) { }
                // Reset local config and persist
                CONFIG.lorryPlates = [];
                CONFIG.hiddenLorryPlates = [];
                CONFIG.archivedLorryPlates = [];
                CONFIG.overrideLorryPlates = true;
                saveConfig(CONFIG);
                await supabaseSaveOptions();
                // Clear current view and reload
                sampleData = [];
                await supabaseLoadSchedule(currentDate);
                populateTable();
                // Expose for manual triggers in console
                window.debugClearAllPlatesDone = true;
            } catch (e) {
                console.warn('Clear all active plates failed', e);
            }
        }

        // Helper to split arrays into chunks for DB operations
        function chunkArray(arr, size) {
            const out = [];
            for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
            return out;
        }

        let CONFIG = loadConfig();
        // Apply customizable trip colors immediately
        applyTripColors(CONFIG);
        let pickUpOptions = (CONFIG.pickUps || []).map(v => String(v).trim()).filter(Boolean);
        let productOptions = (CONFIG.products || []).map(v => String(v).trim()).filter(Boolean);
        let destinationOptions = (CONFIG.destinations || []).map(v => String(v).trim()).filter(Boolean);

        // Utility casing helpers (for consistent display in overlay)
        function norm(s) { return (s || '').toString().trim(); }
        function titleCase(s) {
            const v = norm(s).toLowerCase();
            return v.replace(/(^|\s)([a-z])/g, (m, sep, ch) => sep + ch.toUpperCase());
        }

        // Open large overlay picker (mobile-friendly, easy to read)
        function openOptionsPanel(label, srcOptions, targetInput) {
            const uniqItems = Array.from(
                new Map((srcOptions || []).map(raw => [norm(raw).toLowerCase(), titleCase(raw)])).values()
            ).sort((a, b) => a.localeCompare(b));
            const overlay = document.createElement('div'); overlay.className = 'options-overlay';
            const panel = document.createElement('div'); panel.className = 'options-panel';
            const header = document.createElement('div'); header.className = 'options-header';
            const title = document.createElement('div'); title.className = 'options-title'; title.textContent = `选择：${label || ''}`;
            // Add a clear button to quickly reset accidental selections
            const clearBtn = document.createElement('button');
            clearBtn.className = 'btn btn-secondary';
            clearBtn.textContent = '清除 Clear';
            clearBtn.title = '清除所选值 / Clear selection';
            const list = document.createElement('div'); list.className = 'options-list';
            // Right-side A-Z index for quick jumping
            const alphaIndex = document.createElement('div');
            alphaIndex.className = 'alpha-index';
            // Optional header (currently hidden)
            // panel.appendChild(header);
            header.appendChild(title);
            header.appendChild(clearBtn);
            // Body container to keep alpha index inside the panel column
            const body = document.createElement('div');
            body.className = 'options-body';
            body.appendChild(alphaIndex);
            body.appendChild(list);
            panel.appendChild(body);
            document.body.appendChild(overlay); document.body.appendChild(panel);
            // 无搜索框，直接显示列表
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');
            const getLetter = (s) => {
                const ch = String(s).trim().charAt(0).toUpperCase();
                if (ch >= 'A' && ch <= 'Z') return ch;
                if (ch >= '0' && ch <= '9') return '#';
                return '#';
            };
            const updateAlpha = (present) => {
                alphaIndex.innerHTML = '';
                letters.forEach(L => {
                    const btn = document.createElement('button');
                    btn.className = 'alpha-btn';
                    btn.textContent = L;
                    if (!present.has(L)) {
                        btn.setAttribute('disabled', 'true');
                    } else {
                        btn.addEventListener('click', () => {
                            const anchor = list.querySelector(`#anchor-overlay-${L}`);
                            if (anchor) {
                                const top = anchor.offsetTop;
                                list.scrollTo({ top, behavior: 'smooth' });
                            }
                        });
                    }
                    alphaIndex.appendChild(btn);
                });
            };
            const render = () => {
                const q = '';
                list.innerHTML = '';
                const filtered = uniqItems.filter(v => !q || v.toLowerCase().includes(q));
                const seen = new Set();
                const present = new Set();
                filtered.forEach(v => present.add(getLetter(v)));
                filtered.forEach(v => {
                    const L = getLetter(v);
                    if (!seen.has(L)) {
                        const hdr = document.createElement('div');
                        hdr.className = 'alpha-header';
                        hdr.id = `anchor-overlay-${L}`;
                        hdr.textContent = L;
                        list.appendChild(hdr);
                        seen.add(L);
                    }
                    const div = document.createElement('div'); div.className = 'option-item'; div.textContent = v;
                    div.addEventListener('click', () => { targetInput.value = v; targetInput.dispatchEvent(new Event('input', { bubbles: true })); close(); });
                    list.appendChild(div);
                });
                updateAlpha(present);
            };
            const close = () => { overlay.remove(); panel.remove(); window.__optionsPanel = null; };
            clearBtn.addEventListener('click', () => {
                targetInput.value = '';
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                close();
            });
            render();
            overlay.addEventListener('click', close);
            window.__closeOptionsPanel = close;
            window.__optionsPanel = { close, panel, overlay };
        }

        // Searchable dropdown using an input + datalist (native while typing) + big overlay on click
        // Keeps the same API as before: returns an element with `.value` and calls `onChangeCallback`
        // so existing code continues to work.
        function createDropdown(options, selectedValue = "", onChangeCallback = null, overlayLabel = "") {
            const input = document.createElement('input');
            input.className = 'combo-input';
            input.autocomplete = 'off';
            input.placeholder = '';
            input.value = selectedValue || '';
            input.title = selectedValue || '';
            // Open large overlay on single click for fast selection; keep input read-only to avoid accidental typing
            input.readOnly = true;
            input.setAttribute('aria-readonly', 'true');

            // Normalize once and keep a copy for overlay
            const fullOptions = (options || [])
                .map(o => String(o).trim())
                .filter(Boolean)
                .sort((a, b) => a.localeCompare(b));

            // Notify caller on programmatic value changes (from overlay)
            const handler = () => {
                input.title = input.value || '';
                if (onChangeCallback) onChangeCallback({ target: input });
            };
            input.addEventListener('input', handler);
            input.addEventListener('change', handler);

            // Open overlay on single click for better usability
            const open = () => {
                if (!document.querySelector('.options-panel')) {
                    // Use filtered options if available, otherwise use full options
                    const optionsToUse = input.filteredOptions || fullOptions;
                    openOptionsPanel(overlayLabel || '选择', optionsToUse, input);
                }
            };
            input.addEventListener('click', open);

            return input;
        }

        // Overview layout (cards) for no-scroll view
        function renderOverview() {
            const container = document.getElementById('overviewContainer');
            container.innerHTML = '';
            container.style.display = 'grid';
            // Responsive grid: 3 columns on wide screens, 2 on mid, 1 on small
            container.style.gridTemplateColumns = 'repeat(auto-fit, minmax(360px, 1fr))';
            container.style.gap = '16px';

            sampleData.forEach((row, rowIndex) => {
                const card = document.createElement('div');
                card.className = 'lorry-card';
                card.style.border = '1px solid var(--border)';
                card.style.borderRadius = '12px';
                card.style.background = 'var(--surface)';
                card.style.boxShadow = '0 8px 20px rgba(0,0,0,0.08)';
                card.style.padding = '12px 12px 8px';

                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.marginBottom = '8px';

                const lp = document.createElement('div');
                lp.textContent = `A · Lorry Plate: ${row.lorryPlate}`;
                lp.style.fontWeight = '700';
                lp.style.color = 'var(--primary)';
                header.appendChild(lp);

                card.appendChild(header);

                const tripsWrap = document.createElement('div');
                tripsWrap.style.display = 'grid';
                tripsWrap.style.gridTemplateColumns = 'repeat(3, 1fr)';
                tripsWrap.style.gap = '10px';
                card.appendChild(tripsWrap);

                const trips = [row.trip1, row.trip2, row.trip3];
                const labels = ['Trip 1', 'Trip 2', 'Trip 3'];

                trips.forEach((trip, i) => {
                    const tbox = document.createElement('div');
                    tbox.style.border = '1px solid var(--border)';
                    tbox.style.borderRadius = '10px';
                    tbox.style.background = 'var(--surface-2)';
                    tbox.style.padding = '10px';

                    const title = document.createElement('div');
                    title.textContent = labels[i];
                    title.style.fontWeight = '700';
                    title.style.marginBottom = '6px';
                    tbox.appendChild(title);

                    const grid = document.createElement('div');
                    grid.style.display = 'grid';
                    grid.style.gridTemplateColumns = '1fr';
                    grid.style.rowGap = '8px';

                    // Commission auto-fill helper (strict)
                    let commissionInput;
                    const updateCommission = () => {
                        const puBlank = !(trip.pickUp || '').toString().trim();
                        const prBlank = !(trip.product || '').toString().trim();
                        const deBlank = !(trip.destination || '').toString().trim();
                        if (puBlank || prBlank || deBlank) {
                            trip.commission = '';
                            if (commissionInput) { commissionInput.value = ''; commissionInput.classList.remove('autofilled'); }
                            updateRowStatistics(row, data);
                            return;
                        }
                        const cm = getCommissionFromRules(trip.pickUp, trip.product, trip.destination, currentDate);
                        if (cm != null) {
                            trip.commission = cm;
                            if (commissionInput) { commissionInput.value = cm; commissionInput.classList.add('autofilled'); }
                        } else {
                            trip.commission = '';
                            if (commissionInput) { commissionInput.value = ''; commissionInput.classList.remove('autofilled'); }
                        }
                        updateRowStatistics(row, data);
                    };

                    // Pick Up
                    const puRow = document.createElement('div');
                    puRow.textContent = 'Pick Up';
                    puRow.style.fontSize = '12px';
                    puRow.style.color = 'var(--text-muted)';
                    const pu = createDropdown(pickUpOptions, trip.pickUp, () => {
                        trip.pickUp = pu.value;
                        queueAutosave();
                        updateCommission();
                    }, '工厂');
                    pu.style.width = '100%';
                    tbox.appendChild(puRow);
                    tbox.appendChild(pu);

                    // Product
                    const prRow = document.createElement('div');
                    prRow.textContent = 'Product';
                    prRow.style.fontSize = '12px';
                    prRow.style.color = 'var(--text-muted)';
                    const pr = createDropdown(productOptions, trip.product, () => {
                        trip.product = pr.value;
                        queueAutosave();
                        updateCommission();
                    }, '产品');
                    pr.style.width = '100%';
                    tbox.appendChild(prRow);
                    tbox.appendChild(pr);

                    // Destination
                    const deRow = document.createElement('div');
                    deRow.textContent = 'Destination';
                    deRow.style.fontSize = '12px';
                    deRow.style.color = 'var(--text-muted)';
                    const de = createDropdown(destinationOptions, trip.destination, () => {
                        trip.destination = de.value;
                        queueAutosave();
                        updateCommission();
                    }, '地方');
                    de.style.width = '100%';
                    tbox.appendChild(deRow);
                    tbox.appendChild(de);

                    // Completion
                    const compRow = document.createElement('div');
                    compRow.textContent = 'Completion';
                    compRow.style.fontSize = '12px';
                    compRow.style.color = 'var(--text-muted)';
                    const comp = document.createElement('input');
                    comp.type = 'checkbox';
                    comp.className = 'completion-checkbox';
                    comp.checked = !!trip.completed;
                    comp.addEventListener('change', () => {
                        trip.completed = comp.checked;
                        if (comp.checked) updateCommission();
                        queueAutosave();
                    });
                    tbox.appendChild(compRow);
                    tbox.appendChild(comp);

                    // Commission (RM)
                    const commRow = document.createElement('div');
                    commRow.textContent = '车税（RM）';
                    commRow.style.fontSize = '12px';
                    commRow.style.color = 'var(--text-muted)';
                    commissionInput = document.createElement('input');
                    commissionInput.type = 'number';
                    commissionInput.step = '0.01';
                    commissionInput.min = '0';
                    commissionInput.placeholder = '';
                    commissionInput.className = 'commission-input';
                    commissionInput.value = trip.commission || '';
                    commissionInput.addEventListener('input', () => {
                        trip.commission = commissionInput.value;
                        updateRowStatistics(row, data);
                        queueAutosave();
                    });
                    tbox.appendChild(commRow);
                    tbox.appendChild(commissionInput);
                    // Initial highlight if rule matches current values
                    updateCommission();



                    tripsWrap.appendChild(tbox);
                });

                container.appendChild(card);
            });
        }

        // Toggle between table and overview
        function applyOverviewMode(enabled) {
            const tableContainer = document.querySelector('.table-container');
            const overviewContainer = document.getElementById('overviewContainer');
            const tripContainer = document.getElementById('tripOverviewContainer');
            if (!tableContainer || !overviewContainer) return;
            if (enabled) {
                tableContainer.style.display = 'none';
                overviewContainer.style.display = 'grid';
                if (tripContainer) tripContainer.style.display = 'none';
                renderOverview();
            } else {
                tableContainer.style.display = '';
                overviewContainer.style.display = 'none';
                if (tripContainer) tripContainer.style.display = 'none';
            }
            localStorage.setItem('overviewMode', enabled ? '1' : '0');
        }

        function ensureTripBoardToggle() {
            return; // removed controls
            const actions = document.querySelector('.toolbar-actions');
            if (!actions || actions.__tripBoardAdded) return;
            // Toggle button
            const btn = document.createElement('button');
            btn.className = 'btn btn-secondary';
            btn.id = 'tripBoardToggleBtn';
            const enabled = localStorage.getItem('trip_board_mode') === '1';
            btn.textContent = enabled ? '表格视图' : '活动行程';
            btn.style.marginLeft = '8px';
            btn.addEventListener('click', () => {
                const nowEnabled = localStorage.getItem('trip_board_mode') === '1';
                applyTripBoardMode(!nowEnabled);
                btn.textContent = !nowEnabled ? '表格视图' : '活动行程';
            });
            actions.appendChild(btn);

            // Show/Hide completed toggle
            const chk = document.createElement('label');
            chk.style.display = 'inline-flex';
            chk.style.alignItems = 'center';
            chk.style.gap = '6px';
            chk.style.marginLeft = '8px';
            const cbox = document.createElement('input'); cbox.type = 'checkbox';
            cbox.id = 'toggleShowCompleted';
            cbox.checked = localStorage.getItem('trip_board_show_completed') === '1';
            const sp = document.createElement('span'); sp.textContent = '显示已完成'; sp.style.fontSize = '12px';
            chk.appendChild(cbox); chk.appendChild(sp);
            cbox.addEventListener('change', () => {
                localStorage.setItem('trip_board_show_completed', cbox.checked ? '1' : '0');
                if (localStorage.getItem('trip_board_mode') === '1') renderTripBoard();
            });
            actions.appendChild(chk);

            actions.__tripBoardAdded = true;
        }

        function applyTripBoardMode(enabled) {
            const tableContainer = document.querySelector('.table-container');
            const tripContainer = document.getElementById('tripOverviewContainer');
            if (!tableContainer || !tripContainer) return;
            if (enabled) {
                tableContainer.style.display = 'none';
                tripContainer.style.display = 'grid';
                renderTripBoard();
            } else {
                tableContainer.style.display = '';
                tripContainer.style.display = 'none';
            }
            localStorage.setItem('trip_board_mode', enabled ? '1' : '0');
        }

        function renderTripBoard() {
            const container = document.getElementById('tripOverviewContainer');
            if (!container) return;
            container.innerHTML = '';
            const showCompleted = localStorage.getItem('trip_board_show_completed') === '1';
            // Flatten trips
            const tripsAll = [];
            sampleData.forEach(row => {
                ['trip1', 'trip2', 'trip3', 'trip4', 'trip5'].forEach((k, idx) => {
                    const t = row[k];
                    const filled = (t.pickUp || '').trim() || (t.product || '').trim() || (t.destination || '').trim();
                    if (!filled) return; // skip empty
                    if (!showCompleted && t.completed) return; // skip completed unless enabled
                    tripsAll.push({
                        lorryPlate: row.lorryPlate,
                        tripNo: idx + 1,
                        pickUp: t.pickUp || '',
                        product: t.product || '',
                        destination: t.destination || '',
                        completed: !!t.completed,
                        commission: t.commission || ''
                    });
                });
            });
            // Group by route (PickUp + Destination + Product)
            const groups = new Map();
            const keyOf = (t) => `${t.pickUp} → ${t.destination} · ${t.product}`.trim();
            tripsAll.forEach(t => {
                const k = keyOf(t);
                if (!groups.has(k)) groups.set(k, []);
                groups.get(k).push(t);
            });
            // Render groups
            Array.from(groups.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([route, items]) => {
                const group = document.createElement('div');
                group.className = 'route-group';
                const header = document.createElement('div');
                header.className = 'route-group-header';
                const title = document.createElement('div'); title.className = 'route-group-title'; title.textContent = `${route}`;
                const count = document.createElement('div'); count.textContent = `${items.length} 行程`;
                header.appendChild(title); header.appendChild(count);
                group.appendChild(header);
                const list = document.createElement('div'); list.className = 'trip-list';
                items.sort((a, b) => String(a.lorryPlate).localeCompare(String(b.lorryPlate))).forEach(t => {
                    const card = document.createElement('div'); card.className = 'trip-card';
                    const main = document.createElement('div'); main.className = 'trip-main';
                    const routeLine = document.createElement('div'); routeLine.className = 'trip-route';
                    routeLine.textContent = `${t.lorryPlate} · 行程 ${t.tripNo}`;
                    const meta = document.createElement('div'); meta.className = 'trip-meta';
                    meta.textContent = `${t.pickUp} → ${t.destination} · ${t.product}`;
                    main.appendChild(routeLine); main.appendChild(meta);
                    const actions = document.createElement('div'); actions.className = 'trip-actions';
                    const badge = document.createElement('span'); badge.className = 'commission-badge'; badge.textContent = t.commission ? `RM ${t.commission}` : 'RM —';
                    const chk = document.createElement('input'); chk.type = 'checkbox'; chk.checked = !!t.completed; chk.title = '完成';
                    chk.addEventListener('change', () => {
                        // write back to sampleData
                        const row = sampleData.find(r => r.lorryPlate === t.lorryPlate);
                        if (!row) return;
                        const tripKey = `trip${t.tripNo}`;
                        row[tripKey].completed = chk.checked;
                        queueAutosave();
                        // remove card if we hide completed
                        if (!showCompleted && chk.checked) renderTripBoard();
                    });
                    actions.appendChild(badge); actions.appendChild(chk);
                    card.appendChild(main); card.appendChild(actions);
                    list.appendChild(card);
                });
                group.appendChild(list);
                container.appendChild(group);
            });
        }

        // Trip-by-Trip view removed per request

        // applyTripMode removed

        // ensureTripToggle removed

        // Initialization for Trip view removed; table view remains default

        function createTableRow(data, index) {
            const row = document.createElement('tr');

            // Lorry Plate (Frozen Column)
            const lorryCell = document.createElement('td');
            lorryCell.className = 'frozen-column';
            lorryCell.textContent = data.lorryPlate;
            row.appendChild(lorryCell);

            // Create cells for all 5 trips
            const trips = [data.trip1, data.trip2, data.trip3, data.trip4, data.trip5];

            trips.forEach((trip, tripIndex) => {
                // Commission auto-fill per trip (strict)
                let commissionInput;
                // Reference to completion checkbox so we can reset it when fields change
                let checkbox;
                const updateCommission = () => {
                    const puBlank = !(trip.pickUp || '').toString().trim();
                    const prBlank = !(trip.product || '').toString().trim();
                    const deBlank = !(trip.destination || '').toString().trim();
                    if (puBlank || prBlank || deBlank) {
                        trip.commission = '';
                        if (commissionInput) { commissionInput.value = ''; commissionInput.classList.remove('autofilled'); }
                        updateRowStatistics(row, data);
                        return;
                    }
                    const cm = getCommissionFromRules(trip.pickUp, trip.product, trip.destination, currentDate);
                    if (cm != null) {
                        trip.commission = cm;
                        if (commissionInput) { commissionInput.value = cm; commissionInput.classList.add('autofilled'); }
                    } else {
                        trip.commission = '';
                        if (commissionInput) { commissionInput.value = ''; commissionInput.classList.remove('autofilled'); }
                    }
                    updateRowStatistics(row, data);
                };
                // Pick Up column
                const pickUpCell = document.createElement('td');
                pickUpCell.className = tripIndex === 0 ? `dropdown-cell trip${tripIndex + 1}-bg` : `dropdown-cell trip-separator trip${tripIndex + 1}-bg`;



                const puInput = createDropdown(pickUpOptions, trip.pickUp, (e) => {
                    trip.pickUp = e.target.value;
                    // Ensure completion is manual-only: reset when fields change
                    trip.completed = false;
                    if (checkbox) checkbox.checked = false;

                    // Filter products based on selected pick up location
                    const filteredProducts = getProductsForPickUp(trip.pickUp);
                    if (filteredProducts.length > 0) {
                        // Update the product dropdown with filtered options
                        const productInput = row.querySelector('.dropdown-cell:nth-child(' + (tripIndex * 6 + 3) + ') .combo-input');
                        if (productInput) {
                            // Clear current product selection if it's not in filtered list
                            if (trip.product && !filteredProducts.includes(trip.product)) {
                                trip.product = '';
                                productInput.value = '';
                            }
                            // Store filtered options for this product input
                            productInput.filteredOptions = filteredProducts;
                        }
                    }

                    // Filter destinations based on selected pick up location
                    const filteredDestinations = getDestinationsForPickUp(trip.pickUp);
                    if (filteredDestinations.length > 0) {
                        // Update the destination dropdown with filtered options
                        const destinationInput = row.querySelector('.dropdown-cell:nth-child(' + (tripIndex * 6 + 4) + ') .combo-input');
                        if (destinationInput) {
                            // Clear current destination selection if it's not in filtered list
                            if (trip.destination && !filteredDestinations.includes(trip.destination)) {
                                trip.destination = '';
                                destinationInput.value = '';
                            }
                            // Store filtered options for this destination input
                            destinationInput.filteredOptions = filteredDestinations;
                        }
                    }

                    queueAutosave();
                    updateCommission();
                }, '工厂');
                pickUpCell.appendChild(puInput);
                // Make entire cell clickable to open overlay
                pickUpCell.addEventListener('click', (ev) => {
                    // Avoid double-trigger when clicking the input itself
                    if (ev.target !== puInput) {
                        puInput.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                    }
                });
                row.appendChild(pickUpCell);

                // Product column
                const productCell = document.createElement('td');
                productCell.className = `dropdown-cell trip${tripIndex + 1}-bg`;

                // Apply factory-based filtering for products
                let filteredProducts = productOptions;
                if (trip.pickUp && trip.pickUp.trim()) {
                    const productsForPickUp = getProductsForPickUp(trip.pickUp);
                    if (productsForPickUp.length > 0) {
                        filteredProducts = productsForPickUp;
                    }
                }

                const prInput = createDropdown(filteredProducts, trip.product, (e) => {
                    trip.product = e.target.value;
                    // Ensure completion is manual-only: reset when fields change
                    trip.completed = false;
                    if (checkbox) checkbox.checked = false;
                    queueAutosave();
                    updateCommission();
                }, '产品');
                productCell.appendChild(prInput);
                productCell.addEventListener('click', (ev) => {
                    if (ev.target !== prInput) {
                        prInput.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                    }
                });
                row.appendChild(productCell);

                // Destination column
                const destinationCell = document.createElement('td');
                destinationCell.className = `dropdown-cell trip${tripIndex + 1}-bg`;

                // Apply factory-based filtering for destinations
                let filteredDestinations = destinationOptions;
                if (trip.pickUp && trip.pickUp.trim()) {
                    const destinationsForPickUp = getDestinationsForPickUp(trip.pickUp);
                    if (destinationsForPickUp.length > 0) {
                        filteredDestinations = destinationsForPickUp;
                    }
                }

                const deInput = createDropdown(filteredDestinations, trip.destination, (e) => {
                    trip.destination = e.target.value;
                    // Ensure completion is manual-only: reset when fields change
                    trip.completed = false;
                    if (checkbox) checkbox.checked = false;
                    queueAutosave();
                    updateCommission();
                }, '地方');
                destinationCell.appendChild(deInput);
                destinationCell.addEventListener('click', (ev) => {
                    if (ev.target !== deInput) {
                        deInput.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                    }
                });
                row.appendChild(destinationCell);

                // Completion column
                const completionCell = document.createElement('td');
                completionCell.className = `completion-cell trip${tripIndex + 1}-bg`;
                checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'completion-checkbox';
                checkbox.checked = trip.completed;
                checkbox.addEventListener('change', () => {
                    trip.completed = checkbox.checked;
                    if (checkbox.checked) updateCommission();
                    queueAutosave();
                });
                completionCell.appendChild(checkbox);
                row.appendChild(completionCell);

                // Commission column
                const commissionCell = document.createElement('td');
                commissionCell.className = `dropdown-cell trip${tripIndex + 1}-bg`;
                commissionInput = document.createElement('input');
                commissionInput.type = 'number';
                commissionInput.step = '0.01';
                commissionInput.min = '0';
                commissionInput.placeholder = '';
                commissionInput.className = 'commission-input';
                commissionInput.value = trip.commission || '';
                commissionInput.addEventListener('input', () => {
                    trip.commission = commissionInput.value;
                    updateRowStatistics(row, data);
                    queueAutosave();
                });
                commissionCell.appendChild(commissionInput);
                row.appendChild(commissionCell);

                // Remarks column (reason if not delivered)
                const remarksCell = document.createElement('td');
                remarksCell.className = `dropdown-cell trip${tripIndex + 1}-bg`;
                const remarksInput = document.createElement('input');
                remarksInput.type = 'text';
                remarksInput.placeholder = '';
                remarksInput.className = 'remarks-input';
                remarksInput.readOnly = true;
                remarksInput.style.cursor = 'pointer';
                remarksInput.value = trip.reason || '';
                remarksInput.addEventListener('input', () => {
                    trip.reason = remarksInput.value;
                    queueAutosave();
                });
                remarksInput.addEventListener('click', async () => {
                    await openReasonSelectionPanel(remarksInput);
                });
                remarksCell.appendChild(remarksInput);
                row.appendChild(remarksCell);

                // Initial highlight if rule matches current values
                updateCommission();


            });

            // Add toll amount column (only for the main row, not trip rows)
            if (index !== undefined) {
                const tolAmountCell = document.createElement('td');
                tolAmountCell.className = 'additional-column';
                const tolAmountInput = document.createElement('input');
                tolAmountInput.type = 'number';
                tolAmountInput.step = '0.01';
                tolAmountInput.min = '0';
                tolAmountInput.placeholder = '';
                tolAmountInput.className = 'tol-amount-input';
                tolAmountInput.value = data.tol_amount || '';
                tolAmountInput.addEventListener('input', () => {
                    data.tol_amount = tolAmountInput.value;
                    queueAutosave();
                });
                tolAmountCell.appendChild(tolAmountInput);
                row.appendChild(tolAmountCell);

                // Add petrol amount column
                const petrolAmountCell = document.createElement('td');
                petrolAmountCell.className = 'additional-column';
                const petrolAmountInput = document.createElement('input');
                petrolAmountInput.type = 'number';
                petrolAmountInput.step = '0.01';
                petrolAmountInput.min = '0';
                petrolAmountInput.placeholder = '';
                petrolAmountInput.className = 'petrol-amount-input';
                petrolAmountInput.value = data.petrol_amount || '';
                petrolAmountInput.addEventListener('input', () => {
                    data.petrol_amount = petrolAmountInput.value;
                    queueAutosave();
                });
                petrolAmountCell.appendChild(petrolAmountInput);
                row.appendChild(petrolAmountCell);
            }

            // Statistics cell - calculate total commission
            const statsCell = document.createElement('td');
            statsCell.className = 'stats-column';
            const statsValue = document.createElement('span');
            statsValue.className = 'stats-value';
            statsValue.textContent = calculateTotalCommission(data);
            statsCell.appendChild(statsValue);
            row.appendChild(statsCell);

            return row;
        }

        function populateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            // Only render non-hidden and non-archived lorry plates
            const hiddenSet = new Set(CONFIG.hiddenLorryPlates || []);
            const archivedSet = new Set(CONFIG.archivedLorryPlates || []);
            let visibleRows = sampleData.filter(d => !(hiddenSet.has(d.lorryPlate) || archivedSet.has(d.lorryPlate)));

            // Apply keyword search filter if present
            if (SEARCH_KEYWORD && SEARCH_KEYWORD.trim()) {
                const kw = SEARCH_KEYWORD.trim().toLowerCase();
                const contains = (v) => (v || '').toString().toLowerCase().includes(kw);
                visibleRows = visibleRows.filter(r => {
                    // Match against lorry plate first
                    if (contains(r.lorryPlate)) return true;
                    // Then any trip's pickUp/product/destination
                    const trips = [r.trip1, r.trip2, r.trip3, r.trip4, r.trip5];
                    return trips.some(t => contains(t.pickUp) || contains(t.product) || contains(t.destination));
                });
            }

            visibleRows.forEach((data, index) => {
                const row = createTableRow(data, index);
                if (Array.isArray(window.RECENT_ADDED_PLATES) && window.RECENT_ADDED_PLATES.includes(data.lorryPlate)) {
                    row.classList.add('row-added');
                    setTimeout(() => { row.classList.remove('row-added'); }, 2200);
                }
                tableBody.appendChild(row);
            });
        }

        function addRow(selectedLorryPlate = null) {
            const newData = {
                lorryPlate: selectedLorryPlate || `NEW${Date.now()}`,
                trip1: {
                    pickUp: "",
                    product: "",
                    destination: "",
                    completed: CONFIG && CONFIG.defaultCompletion ? true : false,
                    commission: "",
                    remarks: ""
                },
                trip2: {
                    pickUp: "",
                    product: "",
                    destination: "",
                    completed: CONFIG && CONFIG.defaultCompletion ? true : false,
                    commission: "",
                    remarks: ""
                },
                trip3: {
                    pickUp: "",
                    product: "",
                    destination: "",
                    completed: CONFIG && CONFIG.defaultCompletion ? true : false,
                    commission: "",
                    remarks: ""
                },
                trip4: {
                    pickUp: "",
                    product: "",
                    destination: "",
                    completed: CONFIG && CONFIG.defaultCompletion ? true : false,
                    commission: "",
                    remarks: ""
                },
                trip5: {
                    pickUp: "",
                    product: "",
                    destination: "",
                    completed: CONFIG && CONFIG.defaultCompletion ? true : false,
                    commission: "",
                    remarks: ""
                }
            };

            sampleData.push(newData);
            const tableBody = document.getElementById('tableBody');
            const row = createTableRow(newData, sampleData.length - 1);
            tableBody.appendChild(row);
            queueAutosave();
        }

        // Debounced autosave queue (faster and with flush-on-exit)
        let autosaveTimer = null;
        function queueAutosave(delay = 300) {
            if (autosaveTimer) clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => {
                supabaseSaveSchedule(currentDate, sampleData);
                // Local fallback persistence
                localSaveSchedule(currentDate, sampleData);
                autosaveTimer = null;
            }, Math.max(0, delay));
        }

        function flushAutosave() {
            if (autosaveTimer) {
                clearTimeout(autosaveTimer);
                autosaveTimer = null;
                supabaseSaveSchedule(currentDate, sampleData);
                // Local fallback persistence
                localSaveSchedule(currentDate, sampleData);
            }
        }

        // Local backup helpers so edits survive refresh even if Supabase is unavailable
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        function localSaveSchedule(date, rows) {
            try {
                if (typeof localStorage === 'undefined') return;
                const key = 'planner_schedule_' + formatDateKey(date);
                localStorage.setItem(key, JSON.stringify(rows));
            } catch (_) { /* ignore quota or serialization errors */ }
        }
        function localLoadSchedule(date) {
            try {
                if (typeof localStorage === 'undefined') return null;
                const key = 'planner_schedule_' + formatDateKey(date);
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : null;
            } catch (_) { return null; }
        }

        // Visual feedback helpers
        function showToast(message, type = 'info') {
            const ctr = document.getElementById('toastContainer');
            if (!ctr) return;
            const el = document.createElement('div');
            el.className = 'toast' + (type === 'success' ? ' success' : type === 'warning' ? ' warning' : type === 'danger' ? ' danger' : '');
            el.textContent = message;
            ctr.appendChild(el);
            setTimeout(() => { el.classList.add('fade-out'); setTimeout(() => el.remove(), 320); }, 1600);
        }

        function markUnsaved() {
            const b = document.getElementById('unsavedBadge');
            if (b) { b.style.display = 'inline-block'; b.classList.add('pulse'); }
            window.CONFIG_DIRTY = true;
        }

        function clearUnsaved() {
            const b = document.getElementById('unsavedBadge');
            if (b) { b.style.display = 'none'; b.classList.remove('pulse'); }
            window.CONFIG_DIRTY = false;
        }

        // Keep table row order stable across refreshes
        function sortSampleRows() {
            try {
                const orderMap = new Map();
                (CONFIG.lorryPlates || []).forEach((p, i) => orderMap.set(String(p), i));
                sampleData.sort((a, b) => {
                    const sa = String(a.lorryPlate);
                    const sb = String(b.lorryPlate);
                    const ia = orderMap.has(sa) ? orderMap.get(sa) : Number.MAX_SAFE_INTEGER;
                    const ib = orderMap.has(sb) ? orderMap.get(sb) : Number.MAX_SAFE_INTEGER;
                    if (ia !== ib) return ia - ib;
                    const na = Number(sa), nb = Number(sb);
                    if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
                    return sa.localeCompare(sb);
                });
            } catch (_) { /* non-critical */ }
        }

        // Date navigation functionality
        let currentDate = new Date();
        let SEARCH_KEYWORD = '';

        function formatDate(date) {
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const dayName = days[date.getDay()];

            return `${day}-${month}-${year} (${dayName})`;
        }

        function formatDateISO(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`;
        }

        function updateDateDisplay() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) dateElement.textContent = formatDate(currentDate);
            const picker = document.getElementById('datePicker');
            if (picker) picker.value = formatDateISO(currentDate);
        }

        async function navigateDate(direction) {
            currentDate.setDate(currentDate.getDate() + direction);
            updateDateDisplay();
            await supabaseLoadSchedule(currentDate);
            populateTable();
        }

        // Robust boolean parser for values returned from Supabase
        function parseBoolean(v) {
            if (typeof v === 'boolean') return v;
            if (typeof v === 'number') return v !== 0;
            if (typeof v === 'string') {
                const t = v.trim().toLowerCase();
                if (!t) return false;
                return t === 'true' || t === 't' || t === '1' || t === 'yes' || t === 'y';
            }
            return false;
        }

        // Calculate total commission for all trips in a row
        function calculateTotalCommission(data) {
            let total = 0;
            for (let i = 1; i <= 5; i++) {
                const tripKey = `trip${i}`;
                if (data[tripKey] && data[tripKey].commission) {
                    const commission = parseFloat(data[tripKey].commission) || 0;
                    total += commission;
                }
            }
            return total.toFixed(2);
        }

        // Update statistics display for a specific row
        function updateRowStatistics(row, data) {
            const statsValue = row.querySelector('.stats-value');
            if (statsValue) {
                statsValue.textContent = calculateTotalCommission(data);
            }
        }

        // Load schedule rows for a given date from Supabase
        async function supabaseLoadSchedule(date) {
            if (!sb) {
                const local = localLoadSchedule(date);
                sampleData = Array.isArray(local) ? local : [];
                return;
            }
            try {
                const dstr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const { data, error } = await sb
                    .from('schedules')
                    .select('*')
                    .eq('work_date', dstr);
                if (error) throw error;

                // Build allow-list from current lorry_plates in DB to avoid re-adding deleted plates
                let allowSet = new Set();
                // If local override is active, use local CONFIG list as allow-list
                if (CONFIG && CONFIG.overrideLorryPlates === true) {
                    allowSet = new Set((CONFIG.lorryPlates || []).map(p => String(p)));
                } else {
                    try {
                        const lp = await sb.from('lorry_plates').select('plate_no');
                        if (!lp.error && lp.data) allowSet = new Set(lp.data.map(r => String(r.plate_no)));
                    } catch (_) { /* non-critical */ }
                }

                if (data && data.length) {
                    // Detect remarks columns presence on the schedules table
                    HAS_REASON_COLUMNS = ['t1_reason', 't2_reason', 't3_reason', 't4_reason', 't5_reason'].some(k => k in (data[0] || {}));
                    const filtered = allowSet.size === 0 ? [] : data.filter(s => allowSet.has(String(s.lorry_plate)));
                    sampleData = filtered.map(s => ({
                        lorryPlate: s.lorry_plate,
                        trip1: { pickUp: s.t1_pick_up || '', product: s.t1_product || '', destination: s.t1_destination || '', completed: parseBoolean(s.t1_completed), commission: s.t1_commission != null ? String(Number(s.t1_commission).toFixed(2)) : '', reason: s.t1_reason || '' },
                        trip2: { pickUp: s.t2_pick_up || '', product: s.t2_product || '', destination: s.t2_destination || '', completed: parseBoolean(s.t2_completed), commission: s.t2_commission != null ? String(Number(s.t2_commission).toFixed(2)) : '', reason: s.t2_reason || '' },
                        trip3: { pickUp: s.t3_pick_up || '', product: s.t3_product || '', destination: s.t3_destination || '', completed: parseBoolean(s.t3_completed), commission: s.t3_commission != null ? String(Number(s.t3_commission).toFixed(2)) : '', reason: s.t3_reason || '' },
                        trip4: { pickUp: s.t4_pick_up || '', product: s.t4_product || '', destination: s.t4_destination || '', completed: parseBoolean(s.t4_completed), commission: s.t4_commission != null ? String(Number(s.t4_commission).toFixed(2)) : '', reason: s.t4_reason || '' },
                        trip5: { pickUp: s.t5_pick_up || '', product: s.t5_product || '', destination: s.t5_destination || '', completed: parseBoolean(s.t5_completed), commission: s.t5_commission != null ? String(Number(s.t5_commission).toFixed(2)) : '', reason: s.t5_reason || '' },
                        tol_amount: s.tol_amount != null && Number(s.tol_amount) > 0 ? String(Number(s.tol_amount).toFixed(2)) : '',
                        petrol_amount: s.petrol_amount != null && Number(s.petrol_amount) > 0 ? String(Number(s.petrol_amount).toFixed(2)) : ''
                    }));
                    // Exclude hidden and archived lorry plates from display (persist across refresh)
                    const hiddenSetLoad = new Set(CONFIG.hiddenLorryPlates || []);
                    const archivedSetLoad = new Set(CONFIG.archivedLorryPlates || []);
                    sampleData = sampleData.filter(r => !hiddenSetLoad.has(r.lorryPlate) && !archivedSetLoad.has(r.lorryPlate));
                    // Ensure any active lorry plates from Config also appear, even if no schedule row exists yet
                    try {
                        const hiddenSet = new Set(CONFIG.hiddenLorryPlates || []);
                        const archivedSet = new Set(CONFIG.archivedLorryPlates || []);
                        const existing = new Set(sampleData.map(r => String(r.lorryPlate)));
                        (CONFIG.lorryPlates || [])
                            .filter(p => allowSet.has(String(p)))
                            .filter(p => !hiddenSet.has(p) && !archivedSet.has(p))
                            .forEach(p => {
                                if (!existing.has(String(p))) {
                                    sampleData.push({
                                        lorryPlate: p,
                                        trip1: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                                        trip2: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                                        trip3: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                                        trip4: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                                        trip5: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                                        tol_amount: '',
                                        petrol_amount: ''
                                    });
                                }
                            });
                    } catch (_) { /* non-critical */ }
                    // Merge local cached edits (e.g., remarks) on top of DB data
                    const local = localLoadSchedule(date);
                    if (Array.isArray(local) && local.length) {
                        const map = new Map(local.map(r => [String(r.lorryPlate), r]));
                        sampleData = sampleData.map(r => {
                            const lr = map.get(String(r.lorryPlate));
                            if (!lr) return r;
                            for (let i = 1; i <= 5; i++) {
                                const k = 'trip' + i;
                                if (lr[k] && typeof lr[k].remarks === 'string') {
                                    r[k].remarks = lr[k].remarks || r[k].remarks || '';
                                }
                            }
                            return r;
                        });
                    }
                } else {
                    // No schedules yet for this date: seed rows from Supabase lorry_plates (fallback to local CONFIG)
                    try {
                        const lp = await sb.from('lorry_plates').select('plate_no');
                        const activePlates = (!lp.error && lp.data) ? lp.data.map(r => String(r.plate_no)) : (CONFIG.lorryPlates || []);
                        const hiddenSet = new Set(CONFIG.hiddenLorryPlates || []);
                        sampleData = activePlates.filter(p => !hiddenSet.has(p)).map(plate => ({
                            lorryPlate: plate,
                            trip1: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip2: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip3: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip4: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip5: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                        }));
                        // Apply local cache if available
                        const local = localLoadSchedule(date);
                        if (Array.isArray(local) && local.length) {
                            const map = new Map(local.map(r => [String(r.lorryPlate), r]));
                            sampleData = sampleData.map(r => {
                                const lr = map.get(String(r.lorryPlate));
                                if (!lr) return r;
                                for (let i = 1; i <= 5; i++) {
                                    const k = 'trip' + i;
                                    if (lr[k] && typeof lr[k].remarks === 'string') {
                                        r[k].remarks = lr[k].remarks || r[k].remarks || '';
                                    }
                                }
                                return r;
                            });
                        }
                    } catch (_) {
                        // Fallback to local CONFIG list if DB load fails
                        sampleData = (CONFIG.lorryPlates || []).filter(p => !((CONFIG.hiddenLorryPlates || []).includes(p))).map(plate => ({
                            lorryPlate: plate,
                            trip1: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip2: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip3: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip4: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                            trip5: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '', remarks: '' },
                        }));
                    }
                }

                // Keep Config list in sync with any plates observed in the table (e.g., from existing schedules)
                // This ensures the Config modal matches the Lorry Plate column.
                try {
                    const observedPlates = Array.from(new Set(sampleData.map(r => r.lorryPlate))).filter(p => p && !((CONFIG.archivedLorryPlates || []).includes(p)));
                    const lpSet = new Set(CONFIG.lorryPlates || []);
                    // Only sync plates that still exist in lorry_plates
                    observedPlates.filter(p => allowSet.has(p)).forEach(p => lpSet.add(p));
                    CONFIG.lorryPlates = Array.from(lpSet);
                    saveConfig(CONFIG);
                    // Ensure stable row order after loading
                    sortSampleRows();
                } catch (_) { /* non-critical */ }
            } catch (e) {
                console.error('Failed to load schedule from Supabase', e);
                // On load failure, show empty rather than resurrecting any seeded rows
                sampleData = [];
            }
        }

        // Clear today's schedules (delete all rows for the selected date)
        async function clearTodaySchedule() {
            try {
                const dstr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                await sb.from('schedules').delete().eq('work_date', dstr);
                // Reload after deletion; this will repopulate empty rows for active lorry plates
                await supabaseLoadSchedule(currentDate);
                applyCommissionToSampleData();
                populateTable();
            } catch (e) {
                console.error('Failed to clear today schedules', e);
            }
        }

        // Search wiring - moved to main DOMContentLoaded listener

        // Helper to render chip lists (generic)
        function renderList(container, items, onRemove) {
            container.innerHTML = '';
            items.forEach((item, idx) => {
                const pill = document.createElement('span');
                pill.className = 'config-pill';
                pill.textContent = item;
                const del = document.createElement('button');
                del.textContent = '×';
                del.title = 'Remove';
                del.addEventListener('click', () => onRemove(idx));
                pill.appendChild(del);
                container.appendChild(pill);
            });
        }

        // Alphabet index builder for quick jump within a table
        function updateAlphaIndexFor(tableId, items, filterLow = '') {
            const alphaMap = {
                'tablePickUp': 'alpha-pickup',
                'tableProduct': 'alpha-product',
                'tableDestination': 'alpha-destination'
            };
            const alphaId = alphaMap[tableId];
            if (!alphaId) return;
            const host = document.getElementById(alphaId);
            if (!host) return;

            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');
            // Determine which letters exist in current filtered items
            const present = new Set();
            const getLetter = (s) => {
                const ch = String(s).trim().charAt(0).toUpperCase();
                if (ch >= 'A' && ch <= 'Z') return ch;
                if (ch >= '0' && ch <= '9') return '#';
                return '#';
            };
            items
                .map(v => String(v).trim())
                .filter(v => v.length > 0)
                .filter(v => !filterLow || v.toLowerCase().includes(filterLow))
                .forEach(v => present.add(getLetter(v)));

            host.innerHTML = '';
            letters.forEach(L => {
                const btn = document.createElement('button');
                btn.className = 'alpha-btn';
                btn.textContent = L;
                if (!present.has(L)) {
                    btn.setAttribute('disabled', 'true');
                } else {
                    btn.addEventListener('click', () => {
                        const anchor = document.getElementById(`anchor-${tableId}-${L}`);
                        if (anchor) {
                            anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                }
                host.appendChild(btn);
            });
        }

        // 新增：标签切换与表格渲染，替换原有“标签块”视图，使界面更整齐
        function showTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === tabId));
        }

        function renderItemsTable(tableId, items, filter = '') {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            const low = filter.trim().toLowerCase();
            // Track first occurrence per letter to create anchors
            const seenLetters = new Set();
            const getLetter = (s) => {
                const ch = String(s).trim().charAt(0).toUpperCase();
                if (ch >= 'A' && ch <= 'Z') return ch;
                if (ch >= '0' && ch <= '9') return '#';
                return '#';
            };
            items
                .map(v => String(v).trim())
                .filter(v => v.length > 0)
                .filter(v => !low || v.toLowerCase().includes(low))
                .forEach((it) => {
                    const tr = document.createElement('tr');
                    const letter = getLetter(it);
                    if (!seenLetters.has(letter)) {
                        tr.id = `anchor-${tableId}-${letter}`;
                        seenLetters.add(letter);
                    }
                    const tdName = document.createElement('td'); tdName.textContent = it; tr.appendChild(tdName);
                    const tdAct = document.createElement('td');
                    const btnDel = document.createElement('button'); btnDel.className = 'mini-btn'; btnDel.textContent = '删除';
                    btnDel.addEventListener('click', () => {
                        const originalIdx = items.findIndex(v => String(v).trim() === it);
                        if (originalIdx >= 0) items.splice(originalIdx, 1);
                        renderItemsTable(tableId, items, filter);
                        markUnsaved();
                        showToast(`已删除项 ${it}`, 'danger');
                    });
                    tdAct.appendChild(btnDel);
                    tr.appendChild(tdAct);
                    tbody.appendChild(tr);
                });

            // Update alphabet index for this table
            updateAlphaIndexFor(tableId, items, low);
        }

        // Lorry plates table renderer with status and actions
        function renderLorryTable(filter = '') {
            const table = document.getElementById('tableLorry');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            const low = filter.trim().toLowerCase();
            const hiddenSet = new Set(CONFIG.hiddenLorryPlates || []);
            const archivedSet = new Set(CONFIG.archivedLorryPlates || []);
            const entries = [];
            (CONFIG.lorryPlates || []).forEach(p => entries.push({ plate: p, status: hiddenSet.has(p) ? '隐藏' : '显示' }));

            entries
                .filter(e => !low || e.plate.toLowerCase().includes(low))
                .forEach(e => {
                    const tr = document.createElement('tr');
                    const tdPlate = document.createElement('td'); tdPlate.textContent = e.plate; tr.appendChild(tdPlate);
                    const tdStatus = document.createElement('td'); tdStatus.textContent = e.status; tr.appendChild(tdStatus);
                    const tdAct = document.createElement('td'); tdAct.className = 'config-actions';

                    if (e.status !== '归档') {
                        const btnToggle = document.createElement('button'); btnToggle.className = 'mini-btn';
                        btnToggle.textContent = e.status === '隐藏' ? '显示' : '隐藏';
                        btnToggle.addEventListener('click', async () => {
                            const willHide = e.status !== '隐藏';
                            markUnsaved();
                            await toggleHidePlate(e.plate, willHide);
                            renderLorryTable(filter);
                            renderDeletedLorryTable(filter);
                            showToast(`${willHide ? '已隐藏' : '已显示'}啰里 ${e.plate}`, willHide ? 'warning' : 'success');
                        });
                        tdAct.appendChild(btnToggle);
                    }

                    // 已移除“归档”功能，仅保留 隐藏 / 删除

                    const btnDel = document.createElement('button'); btnDel.className = 'mini-btn'; btnDel.textContent = '删除';
                    btnDel.addEventListener('click', async () => { markUnsaved(); await deletePlatePermanent(e.plate); renderLorryTable(filter); renderDeletedLorryTable(filter); showToast(`已标记删除啰里 ${e.plate}`, 'danger'); });
                    tdAct.appendChild(btnDel);
                    tr.appendChild(tdAct);

                    tbody.appendChild(tr);
                });
        }

        // Render deleted/archived lorry plates
        function renderDeletedLorryTable(filter = '') {
            const table = document.getElementById('tableLorryDeleted');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            const low = filter.trim().toLowerCase();
            const entries = (CONFIG.archivedLorryPlates || []).map(p => ({ plate: p, status: '已删除' }));

            entries
                .filter(e => !low || e.plate.toLowerCase().includes(low))
                .forEach(e => {
                    const tr = document.createElement('tr');
                    const tdPlate = document.createElement('td'); tdPlate.textContent = e.plate; tr.appendChild(tdPlate);
                    const tdStatus = document.createElement('td'); tdStatus.textContent = e.status; tr.appendChild(tdStatus);
                    const tdAct = document.createElement('td'); tdAct.className = 'config-actions';

                    const btnRestore = document.createElement('button'); btnRestore.className = 'mini-btn'; btnRestore.textContent = '恢复';
                    btnRestore.addEventListener('click', async () => { markUnsaved(); await restorePlate(e.plate); renderLorryTable(filter); renderDeletedLorryTable(filter); showToast(`已恢复啰里 ${e.plate}`, 'success'); });
                    tdAct.appendChild(btnRestore);

                    const btnPurge = document.createElement('button'); btnPurge.className = 'mini-btn'; btnPurge.textContent = '彻底删除';
                    btnPurge.addEventListener('click', async () => { markUnsaved(); await purgePlate(e.plate); renderDeletedLorryTable(filter); showToast(`已彻底删除啰里 ${e.plate}`, 'danger'); });
                    tdAct.appendChild(btnPurge);

                    tr.appendChild(tdAct);
                    tbody.appendChild(tr);
                });
        }

        async function toggleHidePlate(plate, hide) {
            const set = new Set(CONFIG.hiddenLorryPlates || []);
            if (hide) set.add(plate); else set.delete(plate);
            CONFIG.hiddenLorryPlates = Array.from(set);
            // If inside config modal and not saved yet, stage only (no persistence)
            if (window.IN_CONFIG_MODAL && !window.CONFIG_MODAL_SAVED) {
                return;
            }
            // Outside modal: persist immediately
            saveConfig(CONFIG);
            try { await sb.from('lorry_plates').update({ hidden: hide }).eq('plate_no', plate); } catch (_) { }
            await supabaseSaveOptions();
            populateTable();
        }

        // 归档功能已移除

        async function deletePlatePermanent(plate) {
            // Stage-only delete: update the modal view and config locally, but do not persist
            const act = new Set(CONFIG.lorryPlates || []); act.delete(plate);
            CONFIG.lorryPlates = Array.from(act);
            // Do not touch archived/hidden or Supabase here; persistence happens on 保存配置
            renderLorryTable('');
        }

        async function restorePlate(plate) {
            // Inside modal: stage-only
            if (window.IN_CONFIG_MODAL && !window.CONFIG_MODAL_SAVED) {
                const arch = new Set(CONFIG.archivedLorryPlates || []); arch.delete(plate);
                CONFIG.archivedLorryPlates = Array.from(arch);
                const act = new Set(CONFIG.lorryPlates || []); act.add(plate);
                CONFIG.lorryPlates = Array.from(act);
                return;
            }
            // Outside modal: persist
            try { await sb.from('lorry_plates').upsert([{ plate_no: plate }], { onConflict: 'plate_no' }); } catch (_) { }
            const arch = new Set(CONFIG.archivedLorryPlates || []); arch.delete(plate);
            CONFIG.archivedLorryPlates = Array.from(arch);
            const act = new Set(CONFIG.lorryPlates || []); act.add(plate);
            CONFIG.lorryPlates = Array.from(act);
            saveConfig(CONFIG);
            await supabaseSaveOptions();
            // Ensure row exists in the schedule view
            const exists = sampleData.some(r => r.lorryPlate === plate);
            if (!exists) {
                sampleData.push({
                    lorryPlate: plate,
                    trip1: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                    trip2: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                    trip3: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                    trip4: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                    trip5: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                });
            }
            populateTable();
            // Persist schedule add
            queueAutosave();
        }

        async function purgePlate(plate) {
            // Inside modal: stage-only remove from archived list
            if (window.IN_CONFIG_MODAL && !window.CONFIG_MODAL_SAVED) {
                CONFIG.archivedLorryPlates = (CONFIG.archivedLorryPlates || []).filter(p => p !== plate);
                return;
            }
            // Remove from archived list and try deleting from Supabase as well
            try {
                const del = await sb.from('lorry_plates').delete().eq('plate_no', plate);
                if (del && del.error) {
                    await sb.from('lorry_plates').update({ active: false, hidden: true }).eq('plate_no', plate);
                }
            } catch (_) {
                try { await sb.from('lorry_plates').update({ active: false, hidden: true }).eq('plate_no', plate); } catch (_) { }
            }
            CONFIG.archivedLorryPlates = (CONFIG.archivedLorryPlates || []).filter(p => p !== plate);
            saveConfig(CONFIG);
            await supabaseSaveOptions();
        }

        function openConfig() {
            console.log('openConfig called');
            console.log('CONFIG:', CONFIG);

            // Snapshot for cancel/close without saving
            window.ORIG_LORRY_PLATES = Array.from(CONFIG.lorryPlates || []);
            // Deep snapshot of entire config for full revert
            window.CONFIG_SNAPSHOT = JSON.parse(JSON.stringify(CONFIG));
            window.CONFIG_MODAL_SAVED = false;
            window.IN_CONFIG_MODAL = true;

            console.log('About to call clearUnsaved');
            clearUnsaved();

            console.log('About to render tables');
            const f = document.getElementById('searchLorry')?.value || '';
            renderLorryTable(f);
            renderItemsTable('tablePickUp', CONFIG.pickUps, document.getElementById('searchPickUp')?.value || '');
            renderItemsTable('tableProduct', CONFIG.products, document.getElementById('searchProduct')?.value || '');
            renderItemsTable('tableDestination', CONFIG.destinations, document.getElementById('searchDestination')?.value || '');

            // 车税与默认设置已移除
            // Prefill color inputs
            console.log('About to set color inputs');
            const c = CONFIG.tripColors || defaultConfig.tripColors;
            const c1 = document.getElementById('colorTrip1'); if (c1) c1.value = c.trip1;
            const c2 = document.getElementById('colorTrip2'); if (c2) c2.value = c.trip2;
            const c3 = document.getElementById('colorTrip3'); if (c3) c3.value = c.trip3;
            const c4 = document.getElementById('colorTrip4'); if (c4) c4.value = c.trip4;
            const c5 = document.getElementById('colorTrip5'); if (c5) c5.value = c.trip5;

            console.log('About to show modal');
            modalManager.open('config');
            console.log('Modal opened using modalManager');

            console.log('About to call showTab');
            showTab('tab-lorry');
            console.log('openConfig completed');
        }

        function closeConfig() {
            // If user didn't save, revert the entire config from snapshot
            if (!window.CONFIG_MODAL_SAVED && window.CONFIG_SNAPSHOT) {
                try {
                    CONFIG = JSON.parse(JSON.stringify(window.CONFIG_SNAPSHOT));
                    saveConfig(CONFIG);
                    populateTable();
                } catch (_) { }
            }
            window.IN_CONFIG_MODAL = false;
            clearUnsaved();
            modalManager.close('config');
        }

        function wireConfigEvents() {
            const btnConfigEl = document.getElementById('topTabConfig');
            if (btnConfigEl) btnConfigEl.addEventListener('click', openConfig);
            const btnMgr = document.getElementById('btnCommissionManager');
            if (btnMgr) {
                btnMgr.addEventListener('click', () => {
                    // Navigate in the same tab (no new window/tab)
                    const target = './commission-manager.html';
                    window.location.assign(target);
                });
            }
            const btnCloseCfg = document.getElementById('btnCloseConfig');
            if (btnCloseCfg) btnCloseCfg.addEventListener('click', closeConfig);
            const btnSaveCfg = document.getElementById('btnSaveConfig');
            if (btnSaveCfg) btnSaveCfg.addEventListener('click', async () => {
                // 默认完成设置已移除
                // Save color selections
                const tcs = CONFIG.tripColors || { ...defaultConfig.tripColors };
                tcs.trip1 = document.getElementById('colorTrip1')?.value || tcs.trip1;
                tcs.trip2 = document.getElementById('colorTrip2')?.value || tcs.trip2;
                tcs.trip3 = document.getElementById('colorTrip3')?.value || tcs.trip3;
                tcs.trip4 = document.getElementById('colorTrip4')?.value || tcs.trip4;
                tcs.trip5 = document.getElementById('colorTrip5')?.value || tcs.trip5;
                CONFIG.tripColors = tcs;
                applyTripColors(CONFIG);
                saveConfig(CONFIG);
                // Apply deletes only now: compute removed vs original snapshot
                const origPlates = Array.isArray(window.ORIG_LORRY_PLATES) ? window.ORIG_LORRY_PLATES : Array.from(CONFIG.lorryPlates || []);
                const newPlates = Array.from(CONFIG.lorryPlates || []);
                const added = newPlates.filter(p => !origPlates.includes(p));
                const removed = origPlates.filter(p => !newPlates.includes(p));
                // Visual feedback summary
                if (added.length) showToast(`已添加 ${added.length} 个啰里：${added.join(', ')}`, 'success');
                if (removed.length) showToast(`已删除 ${removed.length} 个啰里：${removed.join(', ')}`, 'danger');
                // Track for table highlight
                window.RECENT_ADDED_PLATES = added.slice();
                window.RECENT_REMOVED_PLATES = removed.slice();
                if (removed.length) {
                    try {
                        const del = await sb.from('lorry_plates').delete().in('plate_no', removed);
                        if (del && del.error) {
                            await sb.from('lorry_plates').update({ active: false, hidden: true }).in('plate_no', removed);
                        }
                    } catch (_) {
                        try { await sb.from('lorry_plates').update({ active: false, hidden: true }).in('plate_no', removed); } catch (_) { }
                    }
                    // Also remove current-date schedule rows for removed plates
                    try {
                        const dstr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                        await sb.from('schedules').delete().eq('work_date', dstr).in('lorry_plate', removed);
                    } catch (_) { }
                }
                if (added.length) {
                    try {
                        await sb.from('lorry_plates').upsert(
                            added.map(p => ({ plate_no: p, active: true })),
                            { onConflict: 'plate_no' }
                        );
                    } catch (_) { /* non-blocking */ }
                }
                window.CONFIG_MODAL_SAVED = true;
                clearUnsaved();
                await supabaseSaveOptions();
                pickUpOptions = CONFIG.pickUps;
                productOptions = CONFIG.products;
                destinationOptions = CONFIG.destinations;
                // Ensure newly added lorry plates immediately appear as rows
                const existingPlates = new Set(sampleData.map(r => r.lorryPlate));
                CONFIG.lorryPlates.forEach(plate => {
                    if (!existingPlates.has(plate)) {
                        sampleData.push({
                            lorryPlate: plate,
                            trip1: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip2: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip3: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip4: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                            trip5: { pickUp: '', product: '', destination: '', completed: CONFIG.defaultCompletion || false, commission: '' },
                        });
                    }
                });
                // Remove rows for plates that are no longer active (deleted or hidden/archived)
                const activeSet = new Set(CONFIG.lorryPlates || []);
                const hiddenSet = new Set(CONFIG.hiddenLorryPlates || []);
                const archivedSet = new Set(CONFIG.archivedLorryPlates || []);
                sampleData = sampleData.filter(r => activeSet.has(r.lorryPlate) && !hiddenSet.has(r.lorryPlate) && !archivedSet.has(r.lorryPlate));
                // Re-render table so all dropdowns include the latest options
                populateTable();
                // Autosave schedule so new rows are persisted
                flushAutosave();
                // Reload schedule from DB to reflect removals and prevent ghost rows
                await supabaseLoadSchedule(currentDate);
                populateTable();
                queueAutosave();
                closeConfig();
            });
            const btnResetCfg = document.getElementById('btnResetConfig');
            if (btnResetCfg) btnResetCfg.addEventListener('click', () => {
                CONFIG = { ...defaultConfig };
                saveConfig(CONFIG);
                openConfig();
            });

            // Clear all lorry plates (and today's schedules) with one click
            // Removed bulk delete and clear-all controls

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));

            // Live preview for color changes
            ['colorTrip1', 'colorTrip2', 'colorTrip3', 'colorTrip4', 'colorTrip5'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        const tcs = {
                            trip1: document.getElementById('colorTrip1')?.value || CONFIG.tripColors.trip1,
                            trip2: document.getElementById('colorTrip2')?.value || CONFIG.tripColors.trip2,
                            trip3: document.getElementById('colorTrip3')?.value || CONFIG.tripColors.trip3,
                            trip4: document.getElementById('colorTrip4')?.value || CONFIG.tripColors.trip4,
                            trip5: document.getElementById('colorTrip5')?.value || CONFIG.tripColors.trip5
                        };
                        applyTripColors({ tripColors: tcs });
                        markUnsaved();
                    });
                }
            });

            // Add actions and search events
            const btnAddLorry = document.getElementById('btnAddLorry');
            if (btnAddLorry) btnAddLorry.addEventListener('click', async () => {
                const val = document.getElementById('inputLorryPlate').value.trim();
                if (!val) return;
                // Stage-only: update local CONFIG while modal is open; persist on 保存配置
                const lpSet = new Set(CONFIG.lorryPlates || []); lpSet.add(val);
                CONFIG.lorryPlates = Array.from(lpSet);
                CONFIG.hiddenLorryPlates = (CONFIG.hiddenLorryPlates || []).filter(p => p !== val);
                CONFIG.archivedLorryPlates = (CONFIG.archivedLorryPlates || []).filter(p => p !== val);
                // Do not persist or update main table until saved
                document.getElementById('inputLorryPlate').value = '';
                const f = document.getElementById('searchLorry')?.value || '';
                renderLorryTable(f);
                markUnsaved();
                showToast(`已添加啰里 ${val}`, 'success');
            });
            const sl = document.getElementById('searchLorry'); if (sl) sl.addEventListener('input', () => { renderLorryTable(sl.value); });
            const btnAddPickUp = document.getElementById('btnAddPickUp');
            if (btnAddPickUp) btnAddPickUp.addEventListener('click', async () => {
                const val = document.getElementById('inputPickUp').value.trim();
                if (!val) return;
                await upsertOptionAndSync('pickup', val);
                document.getElementById('inputPickUp').value = '';
                renderItemsTable('tablePickUp', CONFIG.pickUps, document.getElementById('searchPickUp')?.value || '');
                markUnsaved();
                showToast(`已添加工厂 ${val}`, 'success');
            });
            const sp = document.getElementById('searchPickUp'); if (sp) sp.addEventListener('input', () => renderItemsTable('tablePickUp', CONFIG.pickUps, sp.value));
            const btnAddProduct = document.getElementById('btnAddProduct');
            if (btnAddProduct) btnAddProduct.addEventListener('click', async () => {
                const val = document.getElementById('inputProduct').value.trim();
                if (!val) return;
                await upsertOptionAndSync('product', val);
                document.getElementById('inputProduct').value = '';
                renderItemsTable('tableProduct', CONFIG.products, document.getElementById('searchProduct')?.value || '');
                markUnsaved();
                showToast(`已添加产品 ${val}`, 'success');
            });
            const sprod = document.getElementById('searchProduct'); if (sprod) sprod.addEventListener('input', () => renderItemsTable('tableProduct', CONFIG.products, sprod.value));
            const btnAddDestination = document.getElementById('btnAddDestination');
            if (btnAddDestination) btnAddDestination.addEventListener('click', async () => {
                const val = document.getElementById('inputDestination').value.trim();
                if (!val) return;
                await upsertOptionAndSync('destination', val);
                document.getElementById('inputDestination').value = '';
                renderItemsTable('tableDestination', CONFIG.destinations, document.getElementById('searchDestination')?.value || '');
                markUnsaved();
                showToast(`已添加地方 ${val}`, 'success');
            });
            const sd = document.getElementById('searchDestination'); if (sd) sd.addEventListener('input', () => renderItemsTable('tableDestination', CONFIG.destinations, sd.value));
            // 已移除：车税添加与搜索事件绑定

            // Add Row button removed per user request; guard in case element exists
            const btnAddRow = document.getElementById('btnAddRow');
            if (btnAddRow) {
                btnAddRow.addEventListener('click', () => {
                    const choice = prompt('Enter lorry plate or choose one:\n' + CONFIG.lorryPlates.join(', '), CONFIG.lorryPlates[0] || '');
                    if (choice !== null) {
                        addRow(choice.trim());
                    }
                });
            }
        }

        async function getOrCreateId(table, keyColumn, value) {
            if (!value) return null;
            const existing = await sb.from(table).select('id,' + keyColumn).eq(keyColumn, value).limit(1).maybeSingle();
            if (!existing.error && existing.data) return existing.data.id;
            const ins = await sb.from(table).insert({ [keyColumn]: value, active: true }).select('id').maybeSingle();
            return ins.data ? ins.data.id : null;
        }

        async function getLorryPlateId(plate) {
            return getOrCreateId('lorry_plates', 'plate', plate);
        }

        async function supabaseSaveSchedule(date, rows) {
            try {
                const dstr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                for (const row of rows) {
                    const payload = {
                        work_date: dstr,
                        lorry_plate: row.lorryPlate,
                        t1_pick_up: row.trip1.pickUp || null,
                        t1_product: row.trip1.product || null,
                        t1_destination: row.trip1.destination || null,
                        t1_completed: !!row.trip1.completed,
                        t1_commission: row.trip1.commission ? Number(row.trip1.commission) : null,
                        t2_pick_up: row.trip2.pickUp || null,
                        t2_product: row.trip2.product || null,
                        t2_destination: row.trip2.destination || null,
                        t2_completed: !!row.trip2.completed,
                        t2_commission: row.trip2.commission ? Number(row.trip2.commission) : null,
                        t3_pick_up: row.trip3.pickUp || null,
                        t3_product: row.trip3.product || null,
                        t3_destination: row.trip3.destination || null,
                        t3_completed: !!row.trip3.completed,
                        t3_commission: row.trip3.commission ? Number(row.trip3.commission) : null,
                        t4_pick_up: row.trip4.pickUp || null,
                        t4_product: row.trip4.product || null,
                        t4_destination: row.trip4.destination || null,
                        t4_completed: !!row.trip4.completed,
                        t4_commission: row.trip4.commission ? Number(row.trip4.commission) : null,
                        t5_pick_up: row.trip5.pickUp || null,
                        t5_product: row.trip5.product || null,
                        t5_destination: row.trip5.destination || null,
                        t5_completed: !!row.trip5.completed,
                        t5_commission: row.trip5.commission ? Number(row.trip5.commission) : null,
                        tol_amount: row.tol_amount ? Number(row.tol_amount) : null,
                        petrol_amount: row.petrol_amount ? Number(row.petrol_amount) : null
                    };
                    // Conditionally include reason fields if the table supports them
                    if (HAS_REASON_COLUMNS) {
                        payload.t1_reason = row.trip1.reason || null;
                        payload.t2_reason = row.trip2.reason || null;
                        payload.t3_reason = row.trip3.reason || null;
                        payload.t4_reason = row.trip4.reason || null;
                        payload.t5_reason = row.trip5.reason || null;
                    }
                    await sb.from('schedules').upsert(payload, { onConflict: 'work_date,lorry_plate' });
                }
                // Autosave succeeded
            } catch (e) {
                console.error('Save schedule failed', e);
            }
        }


        // 全局模态框管理系统
        let modalManager;

        // Initialize the table and date when the page loads
        document.addEventListener('DOMContentLoaded', async function () {
            // 初始化模态框管理系统
            modalManager = {
                modals: {
                    commission: document.getElementById('commissionModal'),
                    dashboard: document.getElementById('dashboardModal'),
                    config: document.getElementById('configModal')
                },

                // 关闭所有模态框
                closeAll() {
                    Object.values(this.modals).forEach(modal => {
                        if (modal) modal.style.display = 'none';
                    });
                },

                // 打开指定模态框（关闭其他）
                open(modalName) {
                    this.closeAll();
                    const modal = this.modals[modalName];
                    if (modal) {
                        modal.style.display = 'flex';
                        return true;
                    }
                    return false;
                },

                // 关闭指定模态框
                close(modalName) {
                    const modal = this.modals[modalName];
                    if (modal) {
                        modal.style.display = 'none';
                        return true;
                    }
                    return false;
                }
            };
            // Theme initialization
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('nanyang_theme', theme);
                const btn = document.getElementById('btnTheme');
                if (btn) btn.textContent = theme === 'readable' ? 'Light Theme' : 'Readable Theme';
            }
            const savedTheme = localStorage.getItem('nanyang_theme') || 'readable';
            applyTheme(savedTheme);

            // Ensure Supabase client is ready (with graceful local fallback)
            await initSupabase();

            if (sb) {
                await supabaseLoadOptions();
                // Load any existing rules from Supabase first
                await loadCommissionRulesFromSupabase();
                mergeCommissionRulesPreferExcel();
                applyCommissionToSampleData();
                // Load reason data for reason selection popup
                await loadReasonGroups();
                await loadReasons();
                await supabaseLoadSchedule(currentDate);
            } else {
                // Local-only: use defaults and any excel commission; no DB schedule
                mergeCommissionRulesPreferExcel();
                applyCommissionToSampleData();
            }
            // After loading schedule rows from DB, apply commission based on active rules again
            applyCommissionToSampleData();
            populateTable();
            updateDateDisplay();
            wireConfigEvents();
            ensureTripBoardToggle();
            // Restore last mode
            const startInBoard = localStorage.getItem('trip_board_mode') === '1';
            applyTripBoardMode(startInBoard);

            const btnTheme = document.getElementById('btnTheme');
            if (btnTheme) {
                btnTheme.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-theme') || 'light';
                    applyTheme(current === 'light' ? 'readable' : 'light');
                });
            }

            // Cross-page sync: receive option updates from embedded Commission Manager
            window.addEventListener('message', async (ev) => {
                const d = ev?.data;
                if (!d) return;
                if (d.type === 'optionsUpdated' && Array.isArray(d.added)) {
                    for (const item of d.added) {
                        const cat = item.category; const name = item.name;
                        await upsertOptionAndSync(cat, name);
                    }
                    // Refresh config modal tables if open
                    if (window.IN_CONFIG_MODAL) {
                        const sp = document.getElementById('searchPickUp');
                        const sprod = document.getElementById('searchProduct');
                        const sd = document.getElementById('searchDestination');
                        renderItemsTable('tablePickUp', CONFIG.pickUps, sp?.value || '');
                        renderItemsTable('tableProduct', CONFIG.products, sprod?.value || '');
                        renderItemsTable('tableDestination', CONFIG.destinations, sd?.value || '');
                    }
                } else if (d.type === 'optionAdded' && d.category && d.name) {
                    await upsertOptionAndSync(d.category, d.name);
                }
            });

            // Search functionality
            const input = document.getElementById('searchInput');
            if (input) {
                let t = null;
                input.addEventListener('input', (e) => {
                    SEARCH_KEYWORD = e.target.value || '';
                    if (t) clearTimeout(t);
                    t = setTimeout(() => populateTable(), 150);
                });
            }

            // 缩放控制（特别为平板优化）
            const zoomOutBtn = document.getElementById('zoomOut');
            const zoomInBtn = document.getElementById('zoomIn');
            const zoomValueEl = document.getElementById('zoomValue');
            const fitAllBtn = document.getElementById('fitAll');
            const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
            let zoom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--zoom')) || 1;
            const applyZoom = () => {
                document.documentElement.style.setProperty('--zoom', String(zoom));
                if (zoomValueEl) zoomValueEl.textContent = Math.round(zoom * 100) + '%';
            };
            applyZoom();
            const step = 0.1;
            const minZoom = 0.4, maxZoom = 2.0; // allow 40% to 200%
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => { zoom = clamp(zoom - step, minZoom, maxZoom); applyZoom(); });
            if (zoomInBtn) zoomInBtn.addEventListener('click', () => { zoom = clamp(zoom + step, minZoom, maxZoom); applyZoom(); });
            if (fitAllBtn) fitAllBtn.addEventListener('click', () => {
                const container = document.querySelector('.table-container');
                const wrapper = document.querySelector('.table-wrapper');
                if (!container || !wrapper) return;
                const needed = container.clientWidth / (wrapper.scrollWidth || container.clientWidth);
                zoom = clamp(needed, minZoom, maxZoom);
                applyZoom();
            });

            // Keyboard shortcuts and ctrl+wheel zoom (useful for trackpads/tablets)
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && (e.key === '+' || e.key === '=')) { e.preventDefault(); zoom = clamp(zoom + step, minZoom, maxZoom); applyZoom(); }
                if (e.ctrlKey && e.key === '-') { e.preventDefault(); zoom = clamp(zoom - step, minZoom, maxZoom); applyZoom(); }
                if (e.ctrlKey && e.key === '0') { e.preventDefault(); zoom = 1; applyZoom(); }
            });
            document.addEventListener('wheel', (e) => {
                if (e.ctrlKey) { e.preventDefault(); const delta = e.deltaY > 0 ? -step : step; zoom = clamp(zoom + delta, minZoom, maxZoom); applyZoom(); }
            }, { passive: false });

            // Calendar date picker wiring
            const dp = document.getElementById('datePicker');
            if (dp) {
                dp.addEventListener('change', async () => {
                    const v = dp.value;
                    if (!v) return;
                    const [yy, mm, dd] = v.split('-').map(Number);
                    currentDate = new Date(yy, (mm || 1) - 1, dd || 1);
                    updateDateDisplay();
                    await supabaseLoadSchedule(currentDate);
                    populateTable();
                });
            }


            // Fit-to-screen initialization
            function applyFitMode(on) {
                const root = document.body;
                if (on) {
                    root.classList.add('fit-width');
                } else {
                    root.classList.remove('fit-width');
                }
                localStorage.setItem('nanyang_fit_width', on ? '1' : '0');
                const btn = document.getElementById('btnFit');
                if (btn) btn.textContent = on ? 'Normal Width' : 'Fit to Screen';
            }
            const savedFit = localStorage.getItem('nanyang_fit_width');
            applyFitMode(savedFit === null ? true : savedFit === '1');
            const btnFit = document.getElementById('btnFit');
            if (btnFit) {
                btnFit.addEventListener('click', () => {
                    const on = !document.body.classList.contains('fit-width');
                    applyFitMode(on);
                });
            }

            // Ensure any pending autosave is flushed when the page is being closed or hidden
            window.addEventListener('beforeunload', flushAutosave);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') flushAutosave();
            });

            // Column sorting functionality
            let currentSort = { column: null, direction: 'asc' };

            function sortTable(column) {
                const tableBody = document.getElementById('tableBody');
                const rows = Array.from(tableBody.querySelectorAll('tr'));

                // Determine sort direction
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                // Update header indicators
                document.querySelectorAll('th.sortable').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });
                const headerCell = document.querySelector(`th[data-column="${column}"]`);
                if (headerCell) {
                    headerCell.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }

                // Sort the data array
                const hiddenSet = new Set(CONFIG.hiddenLorryPlates || []);
                const archivedSet = new Set(CONFIG.archivedLorryPlates || []);
                let visibleData = sampleData.filter(d => !(hiddenSet.has(d.lorryPlate) || archivedSet.has(d.lorryPlate)));

                visibleData.sort((a, b) => {
                    let valueA, valueB;

                    if (column === 'plate') {
                        valueA = a.lorryPlate || '';
                        valueB = b.lorryPlate || '';
                    } else {
                        // Extract trip number and field from column name (e.g., 'pickup1', 'product2')
                        const match = column.match(/^(\w+)(\d+)$/);
                        if (match) {
                            const [, field, tripNum] = match;
                            const tripIndex = parseInt(tripNum) - 1;
                            const tripA = [a.trip1, a.trip2, a.trip3, a.trip4, a.trip5][tripIndex];
                            const tripB = [b.trip1, b.trip2, b.trip3, b.trip4, b.trip5][tripIndex];

                            if (field === 'pickup') {
                                valueA = tripA?.pickUp || '';
                                valueB = tripB?.pickUp || '';
                            } else if (field === 'product') {
                                valueA = tripA?.product || '';
                                valueB = tripB?.product || '';
                            } else if (field === 'destination') {
                                valueA = tripA?.destination || '';
                                valueB = tripB?.destination || '';
                            } else if (field === 'commission') {
                                valueA = parseFloat(tripA?.commission || 0);
                                valueB = parseFloat(tripB?.commission || 0);
                            }
                        }
                    }

                    // Handle numeric vs string comparison
                    if (typeof valueA === 'number' && typeof valueB === 'number') {
                        return currentSort.direction === 'asc' ? valueA - valueB : valueB - valueA;
                    } else {
                        const strA = String(valueA).toLowerCase();
                        const strB = String(valueB).toLowerCase();
                        if (currentSort.direction === 'asc') {
                            return strA.localeCompare(strB);
                        } else {
                            return strB.localeCompare(strA);
                        }
                    }
                });

                // Update the global sampleData array to maintain sort order
                const sortedIndices = visibleData.map(item => sampleData.indexOf(item));
                const newSampleData = [...sampleData];

                // Reorder only the visible items in sampleData
                let visibleIndex = 0;
                for (let i = 0; i < newSampleData.length; i++) {
                    if (!(hiddenSet.has(newSampleData[i].lorryPlate) || archivedSet.has(newSampleData[i].lorryPlate))) {
                        if (visibleIndex < visibleData.length) {
                            newSampleData[i] = visibleData[visibleIndex];
                            visibleIndex++;
                        }
                    }
                }

                sampleData.length = 0;
                sampleData.push(...newSampleData);

                // Repopulate the table
                populateTable();
            }

            // Add click event listeners to sortable headers
            document.querySelectorAll('th.sortable').forEach(th => {
                const column = th.getAttribute('data-column');
                if (column) {
                    th.addEventListener('click', () => sortTable(column));
                }
            });

            // Reason management functionality
            setupReasonManagement();



            // 顶部右侧标签切换（替代 3 点菜单）
            const topTabPlanner = document.getElementById('topTabPlanner');
            const topTabConfig = document.getElementById('topTabConfig');
            const topTabCommission = document.getElementById('topTabCommission');
            const topTabDashboard = document.getElementById('topTabDashboard');
            const commissionModal = document.getElementById('commissionModal');
            const setActive = (el) => {
                [topTabPlanner, topTabConfig, topTabCommission, topTabDashboard].forEach(b => b?.classList.remove('active'));
                el?.classList.add('active');
            };

            if (topTabPlanner) {
                topTabPlanner.addEventListener('click', () => {
                    // Close all modals and return to planner view
                    modalManager.closeAll();
                    try { window.__closeOptionsPanel?.(); } catch (_) { }
                    setActive(topTabPlanner);
                });
            }
            if (topTabConfig) {
                topTabConfig.addEventListener('click', () => {
                    // Open config modal
                    modalManager.open('config');
                    try { window.__closeOptionsPanel?.(); } catch (_) { }
                    setActive(topTabConfig);
                });
            }
            if (topTabCommission) {
                topTabCommission.addEventListener('click', () => {
                    // Open commission modal
                    modalManager.open('commission');
                    try { window.__closeOptionsPanel?.(); } catch (_) { }
                    // Cache-bust iframe to ensure latest UI is shown
                    const ifr = document.getElementById('ifrCommission');
                    if (ifr) {
                        const base = 'commission-manager.html';
                        const v = Date.now();
                        const url = `${base}?v=${v}`;
                        // Only update if URL changed to avoid unnecessary reloads
                        if (ifr.src.indexOf(base) === -1 || !ifr.src.endsWith(String(v))) {
                            ifr.src = url;
                        }
                    }
                    setActive(topTabCommission);
                });
            }
            if (topTabDashboard) {
                topTabDashboard.addEventListener('click', () => {
                    // Open dashboard modal
                    modalManager.open('dashboard');
                    try { window.__closeOptionsPanel?.(); } catch (_) { }
                    setActive(topTabDashboard);
                    // Initialize dashboard
                    initializeDashboard();
                });
            }

            // 关闭车税管理模态框的函数
            function closeCommissionPanel() {
                modalManager.close('commission');
                // 重新激活规划器标签
                const topTabPlanner = document.getElementById('topTabPlanner');
                if (topTabPlanner) {
                    setActive(topTabPlanner);
                }
            }

            // Commission modal close button
            const closeCommission = document.getElementById('closeCommission');
            if (closeCommission) {
                closeCommission.addEventListener('click', closeCommissionPanel);
            }

            // Listen for messages from iframe to close commission panel
            window.addEventListener('message', function (event) {
                // For security, you might want to check event.origin in production
                if (event.data && event.data.action === 'closeCommissionPanel') {
                    closeCommissionPanel();
                }
            });
        });

        // Reason Management Functions
        let reasonGroups = [];
        let reasons = []; // 用于表格显示的筛选后原因
        let allReasons = []; // 存储所有原因的完整数据
        let selectedReasonGroupId = null;

        async function loadReasonGroups() {
            if (!sb) return;
            try {
                const { data, error } = await sb
                    .from('reason_groups')
                    .select('*')
                    .order('name');
                if (error) throw error;
                reasonGroups = data || [];
                renderReasonGroupTable();
                updateReasonGroupSelector();
            } catch (error) {
                console.error('Error loading reason groups:', error);
                showToast('加载原因组合失败', 'danger');
            }
        }

        async function loadReasons(reasonGroupId = null) {
            if (!sb) return;
            try {
                // 总是加载所有原因到 allReasons
                const { data: allData, error: allError } = await sb
                    .from('reasons')
                    .select('*')
                    .order('name');
                if (allError) throw allError;
                allReasons = allData || [];

                // 根据筛选条件设置 reasons 用于表格显示
                if (reasonGroupId) {
                    reasons = allReasons.filter(r => r.reason_group_id === reasonGroupId);
                } else {
                    reasons = allReasons;
                }
                renderReasonTable();
            } catch (error) {
                console.error('Error loading reasons:', error);
                showToast('加载原因失败', 'danger');
            }
        }

        async function addReasonGroup(name, description = '') {
            if (!sb) return;
            try {
                const { data, error } = await sb
                    .from('reason_groups')
                    .insert({ name: name.trim(), description: description.trim() })
                    .select();
                if (error) throw error;
                await loadReasonGroups();
                showToast(`已添加原因组合: ${name}`, 'success');
            } catch (error) {
                console.error('Error adding reason group:', error);
                showToast('添加原因组合失败', 'danger');
            }
        }

        async function deleteReasonGroup(id) {
            if (!sb) return;
            try {
                const { error } = await sb
                    .from('reason_groups')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                await loadReasonGroups();
                if (selectedReasonGroupId === id) {
                    selectedReasonGroupId = null;
                    await loadReasons();
                    updateReasonInputs();
                }
                showToast('已删除原因组合', 'success');
            } catch (error) {
                console.error('Error deleting reason group:', error);
                showToast('删除原因组合失败', 'danger');
            }
        }

        async function addReason(reasonGroupId, name, description = '') {
            if (!sb) return;
            try {
                const { data, error } = await sb
                    .from('reasons')
                    .insert({
                        reason_group_id: reasonGroupId,
                        name: name.trim(),
                        description: description.trim()
                    })
                    .select();
                if (error) throw error;
                await loadReasons();
                await loadReasonGroups(); // Refresh to update reason count
                showToast(`已添加原因: ${name}`, 'success');
            } catch (error) {
                console.error('Error adding reason:', error);
                showToast('添加原因失败', 'danger');
            }
        }

        async function deleteReason(id) {
            if (!sb) return;
            try {
                const { error } = await sb
                    .from('reasons')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                await loadReasons();
                await loadReasonGroups(); // Refresh to update reason count
                showToast('已删除原因', 'success');
            } catch (error) {
                console.error('Error deleting reason:', error);
                showToast('删除原因失败', 'danger');
            }
        }

        function renderReasonGroupTable(filter = '') {
            const tbody = document.querySelector('#tableReasonGroup tbody');
            if (!tbody) return;

            const filteredGroups = reasonGroups.filter(group =>
                group.name.toLowerCase().includes(filter.toLowerCase())
            );

            tbody.innerHTML = filteredGroups.map(group => {
                const reasonCount = reasons.filter(r => r.reason_group_id === group.id).length;
                return `
                    <tr>
                        <td>${group.name}</td>
                        <td>${reasonCount}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="selectReasonGroup(${group.id})">选择</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteReasonGroup(${group.id}, '${group.name}')">删除</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderReasonTable(filter = '') {
            const tbody = document.querySelector('#tableReason tbody');
            if (!tbody) return;

            const filteredReasons = reasons.filter(reason =>
                reason.name.toLowerCase().includes(filter.toLowerCase())
            );

            tbody.innerHTML = filteredReasons.map(reason => `
                <tr>
                    <td>${reason.name}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeleteReason(${reason.id}, '${reason.name}')">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateReasonGroupSelector() {
            const select = document.getElementById('selectReasonGroup');
            if (!select) return;

            select.innerHTML = '<option value="">请先选择原因组合</option>' +
                reasonGroups.map(group =>
                    `<option value="${group.id}" ${group.id === selectedReasonGroupId ? 'selected' : ''}>${group.name}</option>`
                ).join('');
        }

        function updateReasonInputs() {
            const inputReason = document.getElementById('inputReason');
            const btnAddReason = document.getElementById('btnAddReason');
            const searchReason = document.getElementById('searchReason');

            if (selectedReasonGroupId) {
                if (inputReason) inputReason.disabled = false;
                if (btnAddReason) btnAddReason.disabled = false;
                if (searchReason) searchReason.disabled = false;
            } else {
                if (inputReason) inputReason.disabled = true;
                if (btnAddReason) btnAddReason.disabled = true;
                if (searchReason) searchReason.disabled = true;
            }
        }

        function selectReasonGroup(id) {
            selectedReasonGroupId = id;
            updateReasonGroupSelector();
            updateReasonInputs();
            loadReasons(id);
        }

        function confirmDeleteReasonGroup(id, name) {
            if (confirm(`确定要删除原因组合 "${name}" 吗？这将同时删除该组合下的所有原因。`)) {
                deleteReasonGroup(id);
            }
        }

        function confirmDeleteReason(id, name) {
            if (confirm(`确定要删除原因 "${name}" 吗？`)) {
                deleteReason(id);
            }
        }

        // Open reason selection overlay for remarks input
        async function openReasonSelectionPanel(targetInput) {
            if (!reasonGroups.length) {
                showToast('请先在配置页面添加原因组合', 'warning');
                return;
            }

            // 确保使用最新的完整原因数据
            try {
                const { data: latestReasons, error } = await sb
                    .from('reasons')
                    .select('*')
                    .order('name');
                if (error) throw error;
                allReasons = latestReasons || [];
            } catch (error) {
                console.error('Error loading latest reasons:', error);
                showToast('加载原因数据失败', 'danger');
                return;
            }

            const overlay = document.createElement('div');
            overlay.className = 'options-overlay';
            const panel = document.createElement('div');
            panel.className = 'options-panel';
            const header = document.createElement('div');
            header.className = 'options-header';
            const title = document.createElement('div');
            title.className = 'options-title';
            title.textContent = '选择原因';

            // Add a clear button
            const clearBtn = document.createElement('button');
            clearBtn.className = 'btn btn-secondary';
            clearBtn.textContent = '清除 Clear';
            clearBtn.title = '清除所选值 / Clear selection';

            const list = document.createElement('div');
            list.className = 'options-list';

            // Right-side index for reason groups
            const alphaIndex = document.createElement('div');
            alphaIndex.className = 'alpha-index';

            header.appendChild(title);
            header.appendChild(clearBtn);

            const body = document.createElement('div');
            body.className = 'options-body';
            body.appendChild(alphaIndex);
            body.appendChild(list);
            panel.appendChild(body);

            document.body.appendChild(overlay);
            document.body.appendChild(panel);

            const updateIndex = () => {
                alphaIndex.innerHTML = '';
                reasonGroups.forEach(group => {
                    const btn = document.createElement('button');
                    btn.className = 'alpha-btn';
                    btn.textContent = group.name;
                    btn.addEventListener('click', () => {
                        const anchor = list.querySelector(`#anchor-reason-group-${group.id}`);
                        if (anchor) {
                            const top = anchor.offsetTop;
                            list.scrollTo({ top, behavior: 'smooth' });
                        }
                    });
                    alphaIndex.appendChild(btn);
                });
            };

            const render = () => {
                list.innerHTML = '';

                reasonGroups.forEach(group => {
                    // Add reason group header
                    const hdr = document.createElement('div');
                    hdr.className = 'alpha-header';
                    hdr.id = `anchor-reason-group-${group.id}`;
                    hdr.textContent = group.name;
                    list.appendChild(hdr);

                    // Add reasons for this group
                    const groupReasons = allReasons.filter(r => r.reason_group_id === group.id);
                    groupReasons.forEach(reason => {
                        const div = document.createElement('div');
                        div.className = 'option-item';
                        div.textContent = reason.name;
                        div.addEventListener('click', () => {
                            targetInput.value = reason.name;
                            targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                            close();
                        });
                        list.appendChild(div);
                    });

                    // Add empty state if no reasons
                    if (groupReasons.length === 0) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'option-item';
                        emptyDiv.style.fontStyle = 'italic';
                        emptyDiv.style.color = '#888';
                        emptyDiv.textContent = '暂无原因';
                        list.appendChild(emptyDiv);
                    }
                });

                updateIndex();
            };

            const close = () => {
                overlay.remove();
                panel.remove();
                window.__reasonSelectionPanel = null;
            };

            clearBtn.addEventListener('click', () => {
                targetInput.value = '';
                targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                close();
            });

            render();
            overlay.addEventListener('click', close);
            window.__closeReasonSelectionPanel = close;
            window.__reasonSelectionPanel = { close, panel, overlay };
        }

        function setupReasonManagement() {
            // Load initial data
            loadReasonGroups();

            // Reason Group events
            const btnAddReasonGroup = document.getElementById('btnAddReasonGroup');
            if (btnAddReasonGroup) {
                btnAddReasonGroup.addEventListener('click', () => {
                    const input = document.getElementById('inputReasonGroup');
                    const value = input.value.trim();
                    if (value) {
                        addReasonGroup(value);
                        input.value = '';
                    }
                });
            }

            const searchReasonGroup = document.getElementById('searchReasonGroup');
            if (searchReasonGroup) {
                searchReasonGroup.addEventListener('input', (e) => {
                    renderReasonGroupTable(e.target.value);
                });
            }

            // Reason events
            const btnAddReason = document.getElementById('btnAddReason');
            if (btnAddReason) {
                btnAddReason.addEventListener('click', () => {
                    if (!selectedReasonGroupId) return;
                    const input = document.getElementById('inputReason');
                    const value = input.value.trim();
                    if (value) {
                        addReason(selectedReasonGroupId, value);
                        input.value = '';
                    }
                });
            }

            const searchReason = document.getElementById('searchReason');
            if (searchReason) {
                searchReason.addEventListener('input', (e) => {
                    renderReasonTable(e.target.value);
                });
            }

            const selectReasonGroup = document.getElementById('selectReasonGroup');
            if (selectReasonGroup) {
                selectReasonGroup.addEventListener('change', (e) => {
                    const id = e.target.value ? parseInt(e.target.value) : null;
                    selectedReasonGroupId = id;
                    updateReasonInputs();
                    loadReasons(id);
                });
            }
        }

        // 仪表盘功能
        let dashboardChart = null;
        let currentPeriod = 'month';
        let dashboardCurrentDate = new Date();
        let vehicleSort = { key: null, direction: 'none' };
        let lastVehicleData = [];
        let destSort = { key: 'daysSince', direction: 'desc' };
        let lastDestinationData = [];

        function showDashboard() {
            // 使用统一模态框管理打开仪表盘
            modalManager.open('dashboard');
            try { window.__closeOptionsPanel?.(); } catch (_) { }

            // 设置active状态
            const topTabDashboard = document.getElementById('topTabDashboard');
            if (topTabDashboard) {
                [document.getElementById('topTabPlanner'), document.getElementById('topTabConfig'),
                document.getElementById('topTabCommission'), topTabDashboard].forEach(b => b?.classList.remove('active'));
                topTabDashboard.classList.add('active');
            }

            // 初始化仪表盘
            initializeDashboard();
        }

        function hideDashboard() {
            // 使用统一模态框管理关闭仪表盘
            modalManager.close('dashboard');

            // 设置排程标签页为active
            const topTabPlanner = document.getElementById('topTabPlanner');
            if (topTabPlanner) {
                [document.getElementById('topTabPlanner'), document.getElementById('topTabConfig'),
                document.getElementById('topTabCommission'), document.getElementById('topTabDashboard')].forEach(b => b?.classList.remove('active'));
                topTabPlanner.classList.add('active');
            }
        }

        function initializeDashboard() {
            // 设置默认日期
            const dateInput = document.getElementById('periodDate');
            if (dateInput) {
                dateInput.value = dashboardCurrentDate.toISOString().split('T')[0];
            }

            // 设置周期选择器事件
            const periodSelect = document.getElementById('periodSelect');
            if (periodSelect) {
                // 读取初始选中的值
                currentPeriod = periodSelect.value;

                // 添加变化事件监听器
                periodSelect.addEventListener('change', async (e) => {
                    currentPeriod = e.target.value;
                    await refreshDashboard();
                });
            }

            // 设置日期变化事件
            if (dateInput) {
                dateInput.addEventListener('change', async (e) => {
                    dashboardCurrentDate = new Date(e.target.value);
                    await refreshDashboard();
                });
            }

            // 绑定上一期/下一期导航按钮
            const btnPrev = document.getElementById('periodPrev');
            if (btnPrev) {
                btnPrev.addEventListener('click', async () => {
                    await navigateDashboardPeriod(-1);
                });
            }
            const btnNext = document.getElementById('periodNext');
            if (btnNext) {
                btnNext.addEventListener('click', async () => {
                    await navigateDashboardPeriod(1);
                });
            }

            // 绑定表头排序事件
            setupVehicleTableSorting();
            setupDestinationTableSorting();
            // 绑定统计区手风琴折叠
            setupAccordionSections();

            // 初始加载数据
            refreshDashboard();
        }

        // 控制统计周期的上一期/下一期导航
        async function navigateDashboardPeriod(direction) {
            const d = new Date(dashboardCurrentDate);
            if (currentPeriod === 'week') {
                d.setDate(d.getDate() + (7 * direction));
            } else if (currentPeriod === 'month') {
                d.setMonth(d.getMonth() + direction);
            } else if (currentPeriod === 'year') {
                d.setFullYear(d.getFullYear() + direction);
            } else {
                d.setDate(d.getDate() + direction);
            }
            dashboardCurrentDate = d;
            const di = document.getElementById('periodDate');
            if (di) {
                di.value = dashboardCurrentDate.toISOString().split('T')[0];
            }
            await refreshDashboard();
        }

        async function refreshDashboard() {
            const stats = await calculateDashboardStats();
            updateDashboardStats(stats);
            updateDashboardChart(stats.vehicleData);
            lastVehicleData = stats.vehicleData;
            updateVehicleTable(stats.vehicleData);
            // 目的地统计以真实今天为基准
            const today = new Date();
            const destStats = await calculateDestinationStats(today);
            lastDestinationData = destStats;
            applyDestinationSortingAndRender();
            updateDateRange();
        }

        async function calculateDashboardStats() {
            const startDate = getPeriodStartDate(dashboardCurrentDate, currentPeriod);
            const endDate = getPeriodEndDate(dashboardCurrentDate, currentPeriod);

            try {
                // 直接从数据库查询指定时间范围的数据
                const startDateStr = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;

                const { data, error } = await sb
                    .from('schedules')
                    .select('*')
                    .gte('work_date', startDateStr)
                    .lte('work_date', endDateStr);

                if (error) {
                    console.error('Database query error:', error);
                    throw error;
                }

                const vehicleStats = new Map();
                let totalTrips = 0;
                let totalCommission = 0;
                let totalExpenses = 0;

                if (data && data.length > 0) {
                    data.forEach((row, index) => {

                        const plate = String(row.lorry_plate || '').trim();

                        if (!vehicleStats.has(plate)) {
                            vehicleStats.set(plate, {
                                plate: plate,
                                trips: 0,
                                commission: 0,
                                tollFees: 0,
                                fuelCosts: 0
                            });
                        }

                        const stats = vehicleStats.get(plate);
                        const initialTrips = stats.trips;
                        const initialCommission = stats.commission;

                        // 直接从数据库的t1_completed到t5_completed列计算完成的trip数量
                        for (let i = 1; i <= 5; i++) {
                            const completed = row[`t${i}_completed`];
                            const commission = row[`t${i}_commission`];

                            if (completed === true) {
                                stats.trips++;
                                totalTrips++;

                                // 从数据库的t1_commission到t5_commission计算佣金
                                const commissionValue = parseFloat(commission) || 0;
                                stats.commission += commissionValue;
                                totalCommission += commissionValue;

                            }
                        }

                        // 从数据库的tol_amount和petrol_amount计算总开销
                        const tollAmount = parseFloat(row.tol_amount) || 0;
                        const petrolAmount = parseFloat(row.petrol_amount) || 0;
                        const rowExpenses = tollAmount + petrolAmount;

                        stats.tollFees += tollAmount;
                        stats.fuelCosts += petrolAmount;
                        totalExpenses += rowExpenses;

                    });
                }

                const result = {
                    totalVehicles: vehicleStats.size,
                    totalTrips: totalTrips,
                    totalCommission: totalCommission,
                    totalExpenses: totalExpenses,
                    vehicleData: Array.from(vehicleStats.values())
                };

                return result;

            } catch (error) {
                console.error('Error calculating dashboard stats:', error);
                // 返回默认值
                return {
                    totalVehicles: 0,
                    totalTrips: 0,
                    totalCommission: 0,
                    totalExpenses: 0,
                    vehicleData: []
                };
            }
        }

        function getPeriodStartDate(date, period) {
            const d = new Date(date);
            switch (period) {
                case 'week':
                    const dayOfWeek = d.getDay();
                    const diff = d.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // 周一开始
                    return new Date(d.setDate(diff));
                case 'month':
                    return new Date(d.getFullYear(), d.getMonth(), 1);
                case 'year':
                    return new Date(d.getFullYear(), 0, 1);
                default:
                    return d;
            }
        }

        function getPeriodEndDate(date, period) {
            const d = new Date(date);
            switch (period) {
                case 'week':
                    const startOfWeek = getPeriodStartDate(date, period);
                    return new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000);
                case 'month':
                    return new Date(d.getFullYear(), d.getMonth() + 1, 0);
                case 'year':
                    return new Date(d.getFullYear(), 11, 31);
                default:
                    return d;
            }
        }

        function updateDateRange() {
            const startDate = getPeriodStartDate(dashboardCurrentDate, currentPeriod);
            const endDate = getPeriodEndDate(dashboardCurrentDate, currentPeriod);

            // 格式化日期为 DD/MM/YYYY 格式
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };

            const dateRangeText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            const dateRangeElement = document.getElementById('dashboardDateRange');
            if (dateRangeElement) {
                dateRangeElement.textContent = dateRangeText;
            }
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalVehicles').textContent = stats.totalVehicles;
            document.getElementById('totalTrips').textContent = stats.totalTrips;
            document.getElementById('totalCommission').textContent = `RM ${stats.totalCommission.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `RM ${stats.totalExpenses.toFixed(2)}`;
        }

        function updateDashboardChart(vehicleData) {
            const canvas = document.getElementById('vehicleStatsChart');
            if (!canvas) {
                return; // 图表已删除或不存在，直接不绘制
            }
            const ctx = canvas.getContext('2d');

            if (dashboardChart) {
                dashboardChart.destroy();
            }

            const labels = vehicleData.map(v => v.plate);
            const tripsData = vehicleData.map(v => v.trips);
            const commissionData = vehicleData.map(v => v.commission);
            const expensesData = vehicleData.map(v => v.tollFees + v.fuelCosts);

            dashboardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Trip数量',
                            data: tripsData,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '车税 (RM)',
                            data: commissionData,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        },
                        {
                            label: '总开销 (RM)',
                            data: expensesData,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '车牌号'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Trip数量'
                            },
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '金额 (RM)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `车辆统计 - ${getPeriodDisplayName(currentPeriod)}`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateVehicleTable(vehicleData) {
            const tbody = document.querySelector('#vehicleStatsTable tbody');
            tbody.innerHTML = '';

            const data = (vehicleData || []).slice();
            const key = vehicleSort?.key || null;
            const dir = vehicleSort?.direction || 'none';

            if (key && dir !== 'none') {
                data.sort((a, b) => {
                    const getVal = (obj) => {
                        if (key === 'totalExpenses') return (parseFloat(obj.tollFees) || 0) + (parseFloat(obj.fuelCosts) || 0);
                        return obj[key];
                    };
                    const va = getVal(a);
                    const vb = getVal(b);
                    if (key === 'plate') {
                        const pa = String(va || '').trim();
                        const pb = String(vb || '').trim();
                        const cmp = pa.localeCompare(pb, undefined, { numeric: true, sensitivity: 'base' });
                        return dir === 'asc' ? cmp : -cmp;
                    } else {
                        const na = parseFloat(va) || 0;
                        const nb = parseFloat(vb) || 0;
                        const cmp = na - nb;
                        return dir === 'asc' ? cmp : -cmp;
                    }
                });
            }

            data.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${String(vehicle.plate || '').trim()}</td>
                    <td>${vehicle.trips}</td>
                    <td>${vehicle.commission.toFixed(2)}</td>
                    <td>${vehicle.tollFees.toFixed(2)}</td>
                    <td>${vehicle.fuelCosts.toFixed(2)}</td>
                    <td>${(vehicle.tollFees + vehicle.fuelCosts).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 地方订单统计：计算各目的地最后一次运送日期与距今天数
        function toMidnight(d) {
            const nd = new Date(d);
            nd.setHours(0, 0, 0, 0);
            return nd;
        }

        function formatDMY(d) {
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function workingDaysSince(dateFrom, dateTo) {
            const start = new Date(toMidnight(dateFrom));
            const end = new Date(toMidnight(dateTo));
            // 统计从次日开始到目标日，排除周日
            start.setDate(start.getDate() + 1);
            if (end < start) return 0;
            let days = 0;
            const d = new Date(start);
            while (d <= end) {
                if (d.getDay() !== 0) days++; // 0 是周日
                d.setDate(d.getDate() + 1);
            }
            return days;
        }

        async function calculateDestinationStats(referenceDate) {
            const refDateStr = `${referenceDate.getFullYear()}-${String(referenceDate.getMonth() + 1).padStart(2, '0')}-${String(referenceDate.getDate()).padStart(2, '0')}`;
            const map = new Map();
            const baseList = Array.isArray(CONFIG?.destinations) ? CONFIG.destinations : [];
            baseList.forEach(d => map.set(d, null));
            try {
                const { data, error } = await sb
                    .from('schedules')
                    .select('work_date, t1_destination, t1_completed, t2_destination, t2_completed, t3_destination, t3_completed, t4_destination, t4_completed, t5_destination, t5_completed')
                    .lte('work_date', refDateStr);
                if (error) throw error;
                (data || []).forEach(row => {
                    const workDate = new Date(row.work_date);
                    for (let i = 1; i <= 5; i++) {
                        const dest = row[`t${i}_destination`];
                        const completed = parseBoolean(row[`t${i}_completed`]);
                        const filled = (dest || '').trim();
                        if (!filled) continue;
                        if (!completed) continue;
                        const prev = map.get(dest) || null;
                        if (!prev || workDate > prev) {
                            map.set(dest, workDate);
                        }
                    }
                });
            } catch (e) {
                console.error('calculateDestinationStats error', e);
            }
            const results = [];
            map.forEach((dt, dest) => {
                if (!dest || String(dest).trim() === '') return;
                if (!dt) {
                    results.push({ destination: dest, lastDate: '-', lastDateObj: null, daysSince: '-' });
                } else {
                    const days = workingDaysSince(dt, referenceDate);
                    results.push({ destination: dest, lastDate: formatDMY(dt), lastDateObj: new Date(dt), daysSince: days });
                }
            });
            // 默认以距离今天的工作日数降序排列（未送达显示为-）
            results.sort((a, b) => {
                const av = (typeof a.daysSince === 'number') ? a.daysSince : -1;
                const bv = (typeof b.daysSince === 'number') ? b.daysSince : -1;
                if (av !== bv) return bv - av; // gap大的优先显示
                return String(a.destination || '').localeCompare(String(b.destination || ''));
            });
            return results;
        }

        function updateDestinationTable(destData) {
            const tbody = document.querySelector('#destinationStatsTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            (destData || []).forEach(item => {
                const tr = document.createElement('tr');
                const tdDest = document.createElement('td');
                tdDest.textContent = item.destination || '-';
                const tdDate = document.createElement('td');
                tdDate.textContent = item.lastDate || '-';
                const tdDays = document.createElement('td');
                tdDays.textContent = (item.daysSince === '-' ? '-' : String(item.daysSince));
                tr.appendChild(tdDest);
                tr.appendChild(tdDate);
                tr.appendChild(tdDays);
                tbody.appendChild(tr);
            });
        }

        function applyDestinationSortingAndRender() {
            const data = Array.isArray(lastDestinationData) ? [...lastDestinationData] : [];
            const key = destSort?.key || null;
            const dir = destSort?.direction || 'none';
            if (!key || dir === 'none') {
                updateDestinationTable(data);
                return;
            }
            data.sort((a, b) => {
                if (key === 'destination') {
                    const sa = String(a.destination || '').toLowerCase();
                    const sb = String(b.destination || '').toLowerCase();
                    return dir === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
                } else if (key === 'lastDate') {
                    const ta = a.lastDateObj ? a.lastDateObj.getTime() : -1;
                    const tb = b.lastDateObj ? b.lastDateObj.getTime() : -1;
                    return dir === 'asc' ? ta - tb : tb - ta;
                } else if (key === 'daysSince') {
                    const va = (typeof a.daysSince === 'number') ? a.daysSince : -1;
                    const vb = (typeof b.daysSince === 'number') ? b.daysSince : -1;
                    return dir === 'asc' ? va - vb : vb - va;
                }
                return 0;
            });
            updateDestinationTable(data);
        }

        function getPeriodDisplayName(period) {
            switch (period) {
                case 'week': return '本周';
                case 'month': return '本月';
                case 'year': return '本年';
                default: return period;
            }
        }

        function setupVehicleTableSorting() {
            const headers = document.querySelectorAll('#vehicleStatsTable thead th.sortable');
            headers.forEach(h => {
                h.dataset.direction = 'none';
                const ind = h.querySelector('.sort-indicator');
                if (ind) ind.textContent = '';
                h.addEventListener('click', () => {
                    const key = h.dataset.key;
                    if (vehicleSort.key === key) {
                        vehicleSort.direction = vehicleSort.direction === 'none' ? 'asc' : vehicleSort.direction === 'asc' ? 'desc' : 'none';
                    } else {
                        vehicleSort.key = key;
                        vehicleSort.direction = 'asc';
                    }
                    headers.forEach(x => {
                        x.dataset.direction = (x === h) ? vehicleSort.direction : 'none';
                        const i = x.querySelector('.sort-indicator');
                        if (i) {
                            i.textContent = (x === h) ? (vehicleSort.direction === 'asc' ? '↑' : vehicleSort.direction === 'desc' ? '↓' : '') : '';
                        }
                    });
                    // 就地重新渲染，不重新查询数据库
                    updateVehicleTable(lastVehicleData);
                });
            });
        }

        function setupDestinationTableSorting() {
            const headers = document.querySelectorAll('#destinationStatsTable thead th.sortable');
            headers.forEach(h => {
                // 初始化指示器
                h.dataset.direction = (h.dataset.key === destSort.key) ? destSort.direction : 'none';
                const ind = h.querySelector('.sort-indicator');
                if (ind) ind.textContent = (h.dataset.key === destSort.key) ? (destSort.direction === 'asc' ? '↑' : destSort.direction === 'desc' ? '↓' : '') : '';
                h.addEventListener('click', () => {
                    const key = h.dataset.key;
                    if (destSort.key === key) {
                        destSort.direction = destSort.direction === 'none' ? 'asc' : destSort.direction === 'asc' ? 'desc' : 'none';
                    } else {
                        destSort.key = key;
                        destSort.direction = 'asc';
                    }
                    headers.forEach(x => {
                        x.dataset.direction = (x === h) ? destSort.direction : 'none';
                        const i = x.querySelector('.sort-indicator');
                        if (i) {
                            i.textContent = (x === h) ? (destSort.direction === 'asc' ? '↑' : destSort.direction === 'desc' ? '↓' : '') : '';
                        }
                    });
                    applyDestinationSortingAndRender();
                });
            });
        }

        function setupAccordionSections() {
            const sections = [
                document.getElementById('accordionVehicles'),
                document.getElementById('accordionDestinations')
            ];
            sections.forEach(sec => {
                if (!sec) return;
                const header = sec.querySelector('.accordion-header');
                const indicator = sec.querySelector('.accordion-indicator');
                if (!header) return;
                // 初始状态：展开
                sec.classList.remove('collapsed');
                header.setAttribute('aria-expanded', 'true');
                header.addEventListener('click', () => {
                    const isCollapsed = sec.classList.toggle('collapsed');
                    header.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
                    if (indicator) indicator.textContent = isCollapsed ? '▸' : '▾';
                });
            });
        }

        // 在页面加载完成后初始化仪表盘按钮
        document.addEventListener('DOMContentLoaded', function () {
            // 添加返回按钮事件
            const backBtn = document.getElementById('backToMain');
            if (backBtn) {
                backBtn.addEventListener('click', hideDashboard);
            }

            // 添加关闭按钮事件
            const closeBtn = document.getElementById('closeDashboard');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideDashboard);
            }

            // 点击模态框背景关闭
            const dashboardModal = document.getElementById('dashboardModal');
            if (dashboardModal) {
                dashboardModal.addEventListener('click', function (e) {
                    if (e.target === dashboardModal) {
                        hideDashboard();
                    }
                });
            }
        });
    </script>
</body>

</html>